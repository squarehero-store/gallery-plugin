/*!
 * Masonry Grid Gallery Plugin
 * Version: 0.2.4
 * Last Updated: 2026-02-17
 */
!function(){"use strict";class e{constructor(){this.container=document.getElementById("masonry-grid-widget"),this.container?(this.gridData=[],this.isAdminMode=!1,this.activeTab=0,this.hasUnsavedChanges=!1,this.originalData=null,this.sectionId=null,this.lastClickTime=0,this.assetLibraryToken=null,this.assetAuthToken=null,this.currentMediaAssets=[],this.tempRowImages={},this.layoutOptions=[{id:"100",name:"100%",items:1},{id:"50-50",name:"50% / 50%",items:2},{id:"50p-50l",name:"Portrait + Landscape",items:2},{id:"25s-75l",name:"Stack + Landscape",items:3},{id:"67l-33l",name:"2/3 + 1/3",items:2},{id:"33l-67l",name:"1/3 + 2/3",items:2},{id:"67-left",name:"2/3 Left Aligned",items:2},{id:"67-right",name:"2/3 Right Aligned",items:2},{id:"33-33-33",name:"33% / 33% / 33%",items:3},{id:"50-25-25",name:"50% / 25% / 25%",items:3},{id:"25-25-50",name:"25% / 25% / 50%",items:3},{id:"25-50-25",name:"25% / 50% / 25%",items:3},{id:"20-40-40",name:"20% / 40% / 40%",items:3},{id:"40-40-20",name:"40% / 40% / 20%",items:3},{id:"40-20-20",name:"40% / 20% / 20%",items:3},{id:"20-20-40",name:"20% / 20% / 40%",items:3},{id:"25-25-25-25",name:"25% / 25% / 25% / 25%",items:4},{id:"70-15-15",name:"Hero + Grid",items:3},{id:"60-20-20",name:"50 / 25 / 25",items:3},{id:"25-25-50-row",name:"25 / 25 / 50",items:3},{id:"irregular-6",name:"Pinterest Style (5)",items:5},{id:"two-row-6",name:"Two Row Grid (6)",items:6}],this.init()):console.error('Masonry grid target element not found. Please include <div id="masonry-grid-widget"></div> in your HTML.')}async init(){console.log("üéØ Initializing Masonry Grid Widget..."),this.detectSectionId(),this.createHTMLStructure(),this.createAdminControls(),this.initializeElements(),this.attachEventListeners(),this.checkAdminStatus(),await this.loadWidgetData()}createAdminControls(){const e=document.documentElement;if(!e)return void console.warn("No html element found, admin controls will not be injected");const t=document.createElement("div");t.id="masonry-admin-controls",t.className="admin-controls",t.style.display="none",t.innerHTML='\n                <div class="admin-panel">\n                    <div class="admin-header">\n                        <h2 class="admin-title">Edit Gallery</h2>\n                        <div>\n                            <button id="masonry-admin-close-btn" class="admin-close-btn">‚úï</button>\n                        </div>\n                    </div>\n                    <div class="admin-body">\n                        <div class="admin-tabs" id="masonry-admin-tabs"></div>\n                        <div class="admin-form" id="masonry-admin-form"></div>\n                    </div>\n                    <div class="admin-footer">\n                        <div id="masonry-admin-status" class="admin-status" style="display: none;"></div>\n                        <div class="admin-actions">\n                            <button id="masonry-admin-discard-btn" class="btn btn-secondary" style="display: none;">Discard Changes</button>\n                            <button id="masonry-admin-save-btn" class="btn btn-primary" style="display: none;">Save Changes</button>\n                        </div>\n                    </div>\n                </div>\n            ',e.insertBefore(t,e.firstChild)}detectSectionId(){console.log("üîç Starting section ID detection..."),console.log("üìç Container element:",this.container);let e=this.container.closest("section[data-section-id]");if(e)this.sectionId=e.getAttribute("data-section-id"),console.log("‚úÖ Found section ID:",this.sectionId);else if(e=this.container.closest("section"),e){const t=document.querySelectorAll("section"),s=Array.from(t).indexOf(e);this.sectionId=`section-${s}`,console.log("üìç Generated section ID from position:",this.sectionId)}else this.sectionId="default-masonry-grid",console.log("‚ö†Ô∏è No parent section found, using default ID:",this.sectionId)}async checkAdminStatus(){try{await this.isUserAdmin()&&this.adminToggleBtn.classList.remove("hidden")}catch(e){console.log("Admin status check failed")}}async handleAdminToggle(){const e=Date.now();if(e-this.lastClickTime<500)return void console.log("üö´ Ignoring rapid click to prevent accidental admin mode trigger");this.lastClickTime=e;await this.isUserAdmin()?this.toggleAdminMode():(alert("Admin access required. Please log in as an administrator."),this.adminToggleBtn.classList.add("hidden"))}createHTMLStructure(){this.container.innerHTML='\n                \x3c!-- Admin toggle button (shown only to admins) --\x3e\n                <button id="masonry-admin-toggle-btn" class="admin-toggle-btn hidden">Edit Gallery</button>\n                \n                <div class="masonry-grid" id="masonry-grid"></div>\n            '}initializeElements(){this.masonryGrid=document.getElementById("masonry-grid"),this.adminToggleBtn=document.getElementById("masonry-admin-toggle-btn"),this.adminControls=document.getElementById("masonry-admin-controls"),this.adminTabs=document.getElementById("masonry-admin-tabs"),this.adminForm=document.getElementById("masonry-admin-form"),this.adminSaveBtn=document.getElementById("masonry-admin-save-btn"),this.adminCloseBtn=document.getElementById("masonry-admin-close-btn"),this.adminDiscardBtn=document.getElementById("masonry-admin-discard-btn"),this.adminStatus=document.getElementById("masonry-admin-status"),this.adminFooter=this.adminControls.querySelector(".admin-footer")}attachEventListeners(){console.log("üõ°Ô∏è Setting up AGGRESSIVE click blocking with mousedown fallback..."),document.addEventListener("click",e=>{const t=e.target;if(t&&t.closest(".admin-panel")||this.isAdminMode&&t&&t.closest(".masonry-grid-container"))return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!1},!0),document.addEventListener("dblclick",e=>{const t=e.target;if(t&&t.closest(".admin-panel")||this.isAdminMode&&t&&t.closest(".masonry-grid-container"))return console.log("üõ°Ô∏è BLOCKING dblclick event in admin/grid area:",t),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!1},!0);["mouseup","pointerup","touchend"].forEach(e=>{document.addEventListener(e,t=>{const s=t.target;if(s&&s.closest(".admin-panel")||this.isAdminMode&&s&&s.closest(".masonry-grid-container"))return console.log(`üõ°Ô∏è BLOCKING ${e} event in admin/grid area:`,s),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1},!0)}),this.adminToggleBtn.addEventListener("mousedown",e=>{e.preventDefault(),e.stopPropagation(),this.handleAdminToggle()}),this.adminSaveBtn.addEventListener("mousedown",e=>{e.preventDefault(),e.stopPropagation(),this.saveConfiguration()}),this.adminCloseBtn.addEventListener("mousedown",e=>{e.preventDefault(),e.stopPropagation(),this.handleAdminClose()}),this.adminDiscardBtn.addEventListener("mousedown",e=>{e.preventDefault(),e.stopPropagation(),this.discardChanges(),this.toggleAdminMode()}),document.addEventListener("mousedown",e=>{const t=e.target;if(t.closest(".toggle-switch")){e.preventDefault(),e.stopPropagation();const s=t.closest(".toggle-switch"),o=parseInt(s.getAttribute("data-row-index")),i=parseInt(s.getAttribute("data-item-index")),n=s.getAttribute("data-toggle-type"),a=s.classList.contains("active");if("previewVideo"===n){if(this.gridData[o]&&this.gridData[o].items[i]){const e=this.gridData[o].items[i];!a?e.showPreviewUpload=!0:(e.showPreviewUpload=!1,delete e.previewVideo),this.renderAdminForm(),this.markAsChanged()}}else if(this.gridData[o]){const e=!a;"fullWidth"===n?this.gridData[o].fullWidth=e:"cropImages"===n&&(this.gridData[o].cropImages=e),e?s.classList.add("active"):s.classList.remove("active"),this.renderGrid(),this.markAsChanged()}return!1}if(t.closest(".current-layout-display")){e.preventDefault(),e.stopPropagation();const s=t.closest(".visual-layout-selector").dataset.rowIndex;return void 0!==s&&this.toggleLayoutDropdown(parseInt(s)),!1}if(t.closest(".layout-option-dropdown")){e.preventDefault(),e.stopPropagation();const s=t.closest(".layout-option-dropdown"),o=s.getAttribute("data-layout"),i=s.closest(".visual-layout-selector").dataset.rowIndex;return o&&void 0!==i&&this.selectLayoutFromDropdown(o,parseInt(i)),!1}if(t.closest(".area-menu-btn")){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const s=t.closest(".area-menu-btn"),o=s.getAttribute("data-row"),i=s.getAttribute("data-item");return null!==o&&null!==i&&this.toggleAreaContextMenu(parseInt(o),parseInt(i),e),!1}if(t.closest(".area-menu-item")){const s=t.closest(".area-menu-item");if(s.classList.contains("area-btn-library")){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const t=s.getAttribute("data-row"),o=s.getAttribute("data-item");return null!==t&&null!==o&&(this.closeAllAreaContextMenus(),this.selectFromLibrary(parseInt(t),parseInt(o))),!1}if(s.classList.contains("area-btn-upload")){console.log("üñºÔ∏è Context menu upload button mousedown detected for element:",t),e.stopPropagation(),e.stopImmediatePropagation();const o=s.getAttribute("data-row"),i=s.getAttribute("data-item");return null!==o&&null!==i&&(console.log("üñºÔ∏è Starting immediate file picker for position:",o,i),this.closeAllAreaContextMenus(),this.uploadNewImage(parseInt(o),parseInt(i))),!1}if(s.classList.contains("area-btn-remove")){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const t=s.getAttribute("data-row"),o=s.getAttribute("data-item");return null!==t&&null!==o&&(this.closeAllAreaContextMenus(),this.removeImage(parseInt(t),parseInt(o))),!1}}if(t.closest(".area-btn-library")){e.preventDefault(),e.stopPropagation();const s=t.closest(".area-btn-library"),o=s.getAttribute("data-row"),i=s.getAttribute("data-item");return null!==o&&null!==i&&this.selectFromLibrary(parseInt(o),parseInt(i)),!1}if(t.closest(".area-btn-upload")){console.log("üñºÔ∏è Upload button mousedown detected for element:",t),e.stopPropagation(),e.stopImmediatePropagation();const s=t.closest(".area-btn-upload"),o=s.getAttribute("data-row"),i=s.getAttribute("data-item");return null!==o&&null!==i&&(console.log("üñºÔ∏è Starting immediate file picker for position:",o,i),this.uploadNewImage(parseInt(o),parseInt(i))),!1}if(t.closest(".area-btn-remove")){e.preventDefault(),e.stopPropagation();const s=t.closest(".area-btn-remove"),o=s.getAttribute("data-row"),i=s.getAttribute("data-item");return null!==o&&null!==i&&this.removeImage(parseInt(o),parseInt(i)),!1}if(t.closest(".preview-video-select-btn")){e.preventDefault(),e.stopPropagation();const s=t.closest(".preview-video-select-btn"),o=parseInt(s.getAttribute("data-row")),i=parseInt(s.getAttribute("data-item"));return this.gridData[o]&&this.gridData[o].items[i]&&(this.uploadingPreviewVideo={rowIndex:o,itemIndex:i},this.selectFromLibrary(o,i)),!1}if(t.closest(".preview-video-remove")){e.preventDefault(),e.stopPropagation();const s=t.closest(".preview-video-remove"),o=parseInt(s.getAttribute("data-row")),i=parseInt(s.getAttribute("data-item"));return this.gridData[o]&&this.gridData[o].items[i]&&(delete this.gridData[o].items[i].previewVideo,this.renderAdminForm(),this.markAsChanged()),!1}if(t.closest(".row-options-btn")){e.preventDefault(),e.stopPropagation();const s=t.closest(".row-options-btn").getAttribute("data-row-index");return null!==s&&this.showRowOptionsMenu(e,parseInt(s)),!1}if(t.closest(".reorder-toggle-btn"))return e.preventDefault(),e.stopPropagation(),this.toggleReorderMode(),!1;if(t.closest(".row-move-btn")){console.log("üéØ Move button nuclear click handler triggered"),e.preventDefault(),e.stopPropagation();const s=t.closest(".row-move-btn"),o=s.getAttribute("data-row-index"),i=s.getAttribute("data-direction");return console.log("üéØ Move button data:",{rowIndex:o,direction:i}),null!==o&&i&&("up"===i?(console.log("üéØ Moving row up:",o),this.moveRowUp(parseInt(o))):"down"===i&&(console.log("üéØ Moving row down:",o),this.moveRowDown(parseInt(o)))),!1}if(t.closest(".menu-option-draft")){e.preventDefault(),e.stopPropagation();const s=t.closest(".menu-option-draft").getAttribute("data-row-index");return null!==s&&this.toggleRowDraft(parseInt(s)),!1}if(t.closest(".menu-option-duplicate")){e.preventDefault(),e.stopPropagation();const s=t.closest(".menu-option-duplicate").getAttribute("data-row-index");return null!==s&&this.duplicateRow(parseInt(s)),!1}if(t.closest(".menu-option-delete")){e.preventDefault(),e.stopPropagation();const s=t.closest(".menu-option-delete").getAttribute("data-row-index");return null!==s&&this.deleteRow(parseInt(s)),!1}if(t.closest(".btn-danger")&&t.textContent.includes("Delete")){e.preventDefault(),e.stopPropagation();const s=t.closest(".btn-danger").getAttribute("data-row-index");return null!==s&&this.removeRow(parseInt(s)),!1}if(t.closest(".tab-button")){e.preventDefault(),e.stopPropagation();const s=t.closest(".tab-button").getAttribute("data-tab-index");return null!==s&&this.switchTab(parseInt(s)),!1}if(t.closest(".layout-option")){e.preventDefault(),e.stopPropagation();const s=t.closest(".layout-option").getAttribute("data-layout");return s&&this.addRowWithLayout(s),!1}if(t.closest(".asset-grid-item")){e.preventDefault(),e.stopPropagation();const s=t.closest(".asset-grid-item"),o=s.getAttribute("data-asset-index"),i=s.getAttribute("data-row-index"),n=s.getAttribute("data-item-index");if(null!==o&&null!==i&&null!==n){const e=(this.filteredAssets||this.currentMediaAssets)[parseInt(o)];e&&this.selectAsset(e,parseInt(i),parseInt(n))}return!1}return t.closest(".asset-modal-close")||t.closest(".btn-primary")&&"OK"===t.textContent?(e.preventDefault(),e.stopPropagation(),t.closest(".asset-modal-overlay")?.remove(),!1):void 0});["click","mouseup","pointerup","touchend"].forEach(e=>{document.addEventListener(e,t=>{const s=t.target;if(s&&(s.closest(".area-btn-upload")||s.closest(".area-menu-item.area-btn-upload")))return console.log(`üõ°Ô∏è Blocking ${e} event on upload button`),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1},!0)}),document.addEventListener("click",e=>{e.target.closest(".visual-layout-selector")||document.querySelectorAll(".layout-dropdown").forEach(e=>{e.classList.remove("open");const t=e.closest(".visual-layout-selector").querySelector(".dropdown-arrow");t&&(t.style.transform="rotate(0deg)")}),e.target.closest(".area-overlay")||this.closeAllAreaContextMenus()}),document.addEventListener("change",e=>{if(e.target.closest(".height-selector")){const t=e.target.closest(".height-selector"),s=parseInt(t.getAttribute("data-row-index")),o=t.value;this.gridData[s]&&(this.gridData[s].height=o,this.renderGrid(),this.markAsChanged())}})}async isUserAdmin(){try{return(await fetch("/api/config/GetInjectionSettings",{method:"GET",credentials:"include"})).ok}catch(e){return!1}}toggleAdminMode(){this.isAdminMode=!this.isAdminMode,this.isAdminMode?(this.adminBackdrop||(this.adminBackdrop=document.createElement("div"),this.adminBackdrop.className="admin-drawer-backdrop",this.adminBackdrop.addEventListener("click",()=>{this.handleBackdropClick()}),document.body.appendChild(this.adminBackdrop)),this.adminControls.style.display="block",setTimeout(()=>{this.adminControls.classList.add("show"),this.adminBackdrop.classList.add("show")},10),this.adminToggleBtn.style.display="none",document.body.classList.add("admin-drawer-open"),console.log("üîç Admin drawer opened - debugging scroll setup:"),console.log("üì± Body classes:",document.body.className),console.log("üìè Body style overflow:",window.getComputedStyle(document.body).overflow),console.log("üìê Body style position:",window.getComputedStyle(document.body).position),setTimeout(()=>{const e=document.querySelector(".admin-left-column"),t=document.querySelector(".admin-right-column");e?(console.log("üìã Left column found"),console.log("üìã Left column overflow-y:",window.getComputedStyle(e).overflowY),console.log("üìã Left column height:",window.getComputedStyle(e).height),console.log("üìã Left column scroll height:",e.scrollHeight),console.log("üìã Left column client height:",e.clientHeight)):console.log("‚ùå Left column not found"),t?(console.log("üìä Right column found"),console.log("üìä Right column overflow-y:",window.getComputedStyle(t).overflowY),console.log("üìä Right column height:",window.getComputedStyle(t).height),console.log("üìä Right column scroll height:",t.scrollHeight),console.log("üìä Right column client height:",t.clientHeight)):console.log("‚ùå Right column not found")},100),this.originalData=JSON.parse(JSON.stringify(this.gridData)),this.hasUnsavedChanges=!1,this.resetAllAccordionStates(),this.renderAdminForm()):(this.resetReorderMode(),this.adminControls.classList.remove("show"),this.adminBackdrop&&this.adminBackdrop.classList.remove("show"),setTimeout(()=>{this.adminControls.style.display="none"},400),this.adminToggleBtn.style.display="block",this.adminToggleBtn.textContent="Edit Gallery",this.hideAdminFooter(),document.body.classList.remove("admin-drawer-open"),this.hasUnsavedChanges=!1)}resetAllAccordionStates(){document.querySelectorAll(".accordion-item").forEach(e=>{const t=e.querySelector(".accordion-content"),s=e.querySelector(".accordion-arrow");e.classList.remove("expanded"),t&&(t.classList.remove("active"),t.style.display="none"),s&&(s.style.transform="rotate(0deg)")})}saveAccordionStates(){const e=document.querySelectorAll(".accordion-item"),t=[];return e.forEach((e,s)=>{const o=e.classList.contains("expanded");t.push({index:s,isExpanded:o})}),t}restoreAccordionStates(e){if(!e||0===e.length)return;const t=document.querySelectorAll(".accordion-item");e.forEach(e=>{if(t[e.index]&&e.isExpanded){const s=t[e.index],o=s.querySelector(".accordion-content"),i=s.querySelector(".accordion-arrow");s.classList.add("expanded"),o&&(o.style.display="block",o.classList.add("active")),i&&(i.style.transform="rotate(180deg)")}})}saveDetailedAccordionStates(){const e=document.querySelectorAll(".accordion-item"),t=[];return e.forEach(e=>{const s=e.getAttribute("data-row-index"),o=e.classList.contains("expanded");t.push({rowIndex:parseInt(s),isExpanded:o})}),t}restoreDetailedAccordionStates(e){e&&0!==e.length&&e.forEach(e=>{const t=document.querySelector(`[data-row-index="${e.rowIndex}"]`);if(t){const s=t.querySelector(".accordion-content");e.isExpanded?(t.classList.add("expanded"),s&&s.classList.add("active")):(t.classList.remove("expanded"),s&&s.classList.remove("active"))}})}showTabPanel(e){document.querySelectorAll(".tab-panel").forEach(e=>{e.classList.remove("active")});const t=document.querySelector(`[data-panel-index="${e}"]`);t&&t.classList.add("active")}createGridRowsPanel(){const e=document.createElement("div");e.className="admin-main-container";const t=document.createElement("div");t.className="admin-left-column";const s=document.createElement("div");s.className="column-header-container";const o=document.createElement("h3");o.textContent="Current Rows",o.className="column-header";const i=document.createElement("button");i.className="reorder-toggle-btn",i.textContent="Change Order",i.title="Toggle row reordering mode",i.setAttribute("data-reorder-active","false"),s.appendChild(o),s.appendChild(i),t.appendChild(s);const n=document.createElement("div");if(n.className="admin-panel-content",this.gridData.length>0)this.gridData.forEach((e,t)=>{const s=this.createRowAccordion(e,t);n.appendChild(s)});else{const e=document.createElement("div");e.className="empty-state",e.innerHTML="<p>No rows yet. Select a layout from the right panel to add your first row.</p>",n.appendChild(e)}t.appendChild(n);const a=document.createElement("div");a.className="admin-right-column";const r=document.createElement("h3");r.textContent="Add row",r.className="column-header",a.appendChild(r);const l=this.createLayoutBuilder();return a.appendChild(l),e.appendChild(t),e.appendChild(a),e}createStylesPanel(){this.styleSettings||(this.styleSettings={rowGap:50,itemGap:50,mobileRowGap:30,mobileItemGap:20,borderRadius:8,shadow:"none",hoverEffect:"scale",cropImages:!1}),void 0===this.styleSettings.mobileRowGap&&(this.styleSettings.mobileRowGap=30),void 0===this.styleSettings.mobileItemGap&&(this.styleSettings.mobileItemGap=20),void 0===this.styleSettings.cropImages&&(this.styleSettings.cropImages=!1);const e=document.createElement("div");e.className="admin-main-container";const t=document.createElement("div");t.className="admin-left-column",t.style.flex="1",t.style.borderRight="none";const s=document.createElement("h3");s.textContent="Style Settings",s.className="column-header",t.appendChild(s);const o=document.createElement("div");o.className="styles-panel-container";const i=document.createElement("div");i.className="style-section";const n=document.createElement("h3");n.textContent="Spacing",n.className="style-section-title",i.appendChild(n);const a=this.createRangeControl("Row Gap","rowGap",this.styleSettings.rowGap,0,300,"px");i.appendChild(a);const r=this.createRangeControl("Item Gap","itemGap",this.styleSettings.itemGap,0,300,"px");i.appendChild(r);const l=this.createRangeControl("Mobile Row Gap","mobileRowGap",this.styleSettings.mobileRowGap||30,0,300,"px");i.appendChild(l);const d=this.createRangeControl("Mobile Item Gap","mobileItemGap",this.styleSettings.mobileItemGap||20,0,300,"px");i.appendChild(d),o.appendChild(i);const c=document.createElement("div");c.className="style-section";const u=document.createElement("h3");u.textContent="Border Radius",u.className="style-section-title",c.appendChild(u);const m=this.createRangeControl("Corner Radius","borderRadius",this.styleSettings.borderRadius,0,50,"px");c.appendChild(m);const h=document.createElement("div");h.className="style-section";const p=document.createElement("h3");p.textContent="Effects",p.className="style-section-title",h.appendChild(p);const g=this.createSelectControl("Shadow","shadow",this.styleSettings.shadow,[{value:"none",label:"None"},{value:"light",label:"Light"},{value:"medium",label:"Medium"},{value:"heavy",label:"Heavy"}]);h.appendChild(g);const v=this.createSelectControl("Hover Effect","hoverEffect",this.styleSettings.hoverEffect,[{value:"none",label:"None"},{value:"scale",label:"Scale"},{value:"lift",label:"Lift"},{value:"fade",label:"Fade"}]);h.appendChild(v);const y=this.createSelectControl("Crop Images to Fit","cropImages",this.styleSettings.cropImages,[{value:!0,label:"Yes"},{value:!1,label:"No"}]);h.appendChild(y),o.appendChild(i),o.appendChild(c),o.appendChild(h),t.appendChild(o);const w=document.createElement("div");w.className="admin-right-column",w.style.display="none";const f=document.createElement("h3");f.textContent="Preview",f.className="column-header",w.appendChild(f);const b=this.createStylePreview();return w.appendChild(b),e.appendChild(t),e.appendChild(w),e}createStylePreview(){const e=document.createElement("div");e.className="style-preview-container",e.id="style-preview-container";const t=document.createElement("div");t.className="style-preview-grid";const s=document.createElement("div");s.className="style-preview-row";const o=document.createElement("div");o.className="style-preview-row";const i=this.createPreviewItem("#667eea","1"),n=this.createPreviewItem("#f093fb","2");s.appendChild(i),s.appendChild(n);const a=this.createPreviewItem("#4facfe","3"),r=this.createPreviewItem("#43e97b","4"),l=this.createPreviewItem("#fa709a","5");o.appendChild(a),o.appendChild(r),o.appendChild(l),t.appendChild(s),t.appendChild(o),e.appendChild(t);const d=document.createElement("div");return d.className="preview-instructions",d.innerHTML="<p><small>Live preview of your style settings. Hover over items to see effects!</small></p>",e.appendChild(d),this.updatePreviewStyles(),e}createPreviewItem(e,t){const s=document.createElement("div");s.className="style-preview-item";const o=document.createElement("div");o.className="style-preview-item-image",o.style.backgroundColor=e,o.style.width="100%",o.style.height="100%";const i=document.createElement("span");return i.className="preview-item-label",i.textContent=t,o.appendChild(i),s.appendChild(o),s}updatePreviewStyles(){if(!document.getElementById("style-preview-container"))return;const e=document.createElement("style");e.id="style-preview-dynamic-styles";const t=document.getElementById("style-preview-dynamic-styles");t&&t.remove();const s=`\n                .style-preview-row {\n                    margin-bottom: ${this.styleSettings.rowGap??50}px !important;\n                    gap: ${this.styleSettings.itemGap??50}px !important;\n                }\n                \n                .style-preview-item {\n                    border-radius: ${this.styleSettings.borderRadius??8}px !important;\n                    overflow: hidden !important;\n                    ${this.getPreviewShadowCSS()}\n                }\n                \n                .style-preview-item-image {\n                    border-radius: ${this.styleSettings.borderRadius??8}px !important;\n                    ${this.getImageFitCSS()}\n                    ${this.getPreviewHoverEffectCSS()}\n                }\n            `;e.textContent=s,document.head.appendChild(e)}getPreviewShadowCSS(){return{none:"",light:"box-shadow: 0 2px 8px rgba(0,0,0,0.1);",medium:"box-shadow: 0 4px 16px rgba(0,0,0,0.15);",heavy:"box-shadow: 0 8px 32px rgba(0,0,0,0.25);"}[this.styleSettings.shadow]||""}getPreviewHoverEffectCSS(){return{none:"",scale:"transition: transform 0.3s ease; } .style-preview-item:hover .style-preview-item-image { transform: scale(1.05);",lift:"transition: transform 0.3s ease, box-shadow 0.3s ease; } .style-preview-item:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.15);",fade:"transition: opacity 0.3s ease; } .style-preview-item:hover .style-preview-item-image { opacity: 0.8;"}[this.styleSettings.hoverEffect]||""}createRangeControl(e,t,s,o,i,n){const a=document.createElement("div");a.className="style-control-group";const r=document.createElement("label");r.textContent=e,r.className="style-control-label";const l=document.createElement("div");l.className="range-input-container";const d=document.createElement("input");d.type="range",d.min=o,d.max=i,d.value=s,d.className="style-range-input";const c=document.createElement("span");return c.textContent=`${s}${n}`,c.className="style-value-display",d.addEventListener("input",e=>{const s=parseInt(e.target.value);c.textContent=`${s}${n}`,this.styleSettings[t]=s,this.updateStyles(),this.updatePreviewStyles(),this.markAsChanged()}),d.addEventListener("mousedown",e=>{e.stopPropagation()}),d.addEventListener("click",e=>{e.stopPropagation()}),l.appendChild(d),l.appendChild(c),a.appendChild(r),a.appendChild(l),a}createSelectControl(e,t,s,o){const i=document.createElement("div");i.className="style-control-group";const n=document.createElement("label");n.textContent=e,n.className="style-control-label";const a=document.createElement("select");return a.className="style-select-input",o.forEach(e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,t.selected=e.value===s,a.appendChild(t)}),a.addEventListener("change",e=>{let s=e.target.value;"true"===s&&(s=!0),"false"===s&&(s=!1),this.styleSettings[t]=s,this.updateStyles(),this.updatePreviewStyles(),this.markAsChanged()}),a.addEventListener("mousedown",e=>{e.stopPropagation()}),a.addEventListener("click",e=>{e.stopPropagation()}),i.appendChild(n),i.appendChild(a),i}createToggleControl(e,t,s){const o=document.createElement("div");o.className="style-control-group";const i=document.createElement("label");i.textContent=e,i.className="style-control-label";const n=document.createElement("div");n.className="toggle-container";const a=document.createElement("div");return a.className="toggle-switch "+(s?"active":""),a.innerHTML=`\n                <div class="toggle-slider"></div>\n                <span class="toggle-label">${s?"On":"Off"}</span>\n            `,a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const s=!this.styleSettings[t];this.styleSettings[t]=s,a.classList.toggle("active",s),a.querySelector(".toggle-label").textContent=s?"On":"Off",this.updateStyles(),this.updatePreviewStyles(),this.markAsChanged()}),n.appendChild(a),o.appendChild(i),o.appendChild(n),o}updateStyles(){const e=document.querySelector(".masonry-container");e&&(e.style.setProperty("--item-gap",`${this.styleSettings.itemGap??50}px`),e.style.setProperty("--row-gap",`${this.styleSettings.rowGap??50}px`),e.style.setProperty("--mobile-item-gap",`${this.styleSettings.mobileItemGap??20}px`),e.style.setProperty("--mobile-row-gap",`${this.styleSettings.mobileRowGap??30}px`),e.style.setProperty("--border-radius",`${this.styleSettings.borderRadius??8}px`),e.classList.remove("image-crop","no-crop"),!1===this.styleSettings.cropImages?e.classList.add("no-crop"):e.classList.add("image-crop"));const t=document.createElement("style");t.id="masonry-dynamic-styles";const s=document.getElementById("masonry-dynamic-styles");s&&s.remove();const o=`\n                .masonry-item {\n                    border-radius: var(--border-radius) !important;\n                    overflow: hidden !important;\n                    ${this.getShadowCSS()}\n                }\n                \n                .masonry-item-image {\n                    border-radius: var(--border-radius) !important;\n                    ${this.getImageFitCSS()}\n                    ${this.getHoverEffectCSS()}\n                }\n                \n                /* Override border radius for full-width rows */\n                .masonry-row.full-width .masonry-item,\n                .masonry-row.full-width .masonry-item-image {\n                    border-radius: 0 !important;\n                }\n            `;t.textContent=o,document.head.appendChild(t)}getShadowCSS(){return{none:"",light:"box-shadow: 0 2px 8px rgba(0,0,0,0.1);",medium:"box-shadow: 0 4px 16px rgba(0,0,0,0.15);",heavy:"box-shadow: 0 8px 32px rgba(0,0,0,0.25);"}[this.styleSettings.shadow]||""}getHoverEffectCSS(){return{none:"",scale:"transition: transform 0.3s ease; } .masonry-item:hover .masonry-item-image { transform: scale(1.05);",lift:"transition: transform 0.3s ease, box-shadow 0.3s ease; } .masonry-item:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.15);",fade:"transition: opacity 0.3s ease; } .masonry-item:hover .masonry-item-image { opacity: 0.8;"}[this.styleSettings.hoverEffect]||""}getImageFitCSS(){return!1===this.styleSettings.cropImages?"object-fit: contain !important;":"object-fit: cover !important;"}renderAdminForm(){const e=this.saveDetailedAccordionStates();this.adminTabs.innerHTML="",this.adminForm.innerHTML="";const t=document.createElement("button");t.className="admin-tab active tab-button",t.textContent="Grid Rows",t.setAttribute("data-tab-index","0");const s=document.createElement("button");s.className="admin-tab tab-button",s.textContent="Styles",s.setAttribute("data-tab-index","1"),this.adminTabs.appendChild(t),this.adminTabs.appendChild(s),[t,s].forEach(e=>{e.addEventListener("mousedown",t=>{t.preventDefault(),t.stopPropagation(),this.adminTabs.querySelectorAll(".admin-tab").forEach(e=>e.classList.remove("active")),e.classList.add("active"),this.showTabPanel(parseInt(e.getAttribute("data-tab-index")))})});const o=document.createElement("div");o.className="tab-panels-container";const i=this.createGridRowsPanel();i.className="tab-panel active",i.setAttribute("data-panel-index","0");const n=this.createStylesPanel();n.className="tab-panel",n.setAttribute("data-panel-index","1"),o.appendChild(i),o.appendChild(n),this.adminForm.appendChild(o),setTimeout(()=>this.restoreDetailedAccordionStates(e),0),setTimeout(()=>{this.addScrollDebugging()},100)}createLayoutBuilder(){const e=document.createElement("div");e.className="layout-builder";return[{id:"100",name:"Single",preview:this.createLayoutPreview("100","builder")},{id:"50-50",name:"Half & Half",preview:this.createLayoutPreview("50-50","builder")},{id:"50p-50l",name:"Portrait + Landscape",preview:this.createLayoutPreview("50p-50l","builder")},{id:"25s-75l",name:"Stack + Landscape",preview:this.createLayoutPreview("25s-75l","builder")},{id:"67l-33l",name:"2/3 + 1/3",preview:this.createLayoutPreview("67l-33l","builder")},{id:"33l-67l",name:"1/3 + 2/3",preview:this.createLayoutPreview("33l-67l","builder")},{id:"67-left",name:"2/3 Left Aligned",preview:this.createLayoutPreview("67-left","builder")},{id:"67-right",name:"2/3 Right Aligned",preview:this.createLayoutPreview("67-right","builder")},{id:"33-33-33",name:"3 Columns",preview:this.createLayoutPreview("33-33-33","builder")},{id:"25-25-25-25",name:"4 Columns",preview:this.createLayoutPreview("25-25-25-25","builder")},{id:"25-50-25",name:"Side + Center + Side",preview:this.createLayoutPreview("25-50-25","builder")},{id:"50-25-25",name:"Left + Stack",preview:this.createLayoutPreview("50-25-25","builder")},{id:"25-25-50",name:"Right + Stack",preview:this.createLayoutPreview("25-25-50","builder")},{id:"20-40-40",name:"20 / 40 / 40",preview:this.createLayoutPreview("20-40-40","builder")},{id:"40-40-20",name:"40 / 40 / 20",preview:this.createLayoutPreview("40-40-20","builder")},{id:"40-20-20",name:"40 / 20 / 20",preview:this.createLayoutPreview("40-20-20","builder")},{id:"20-20-40",name:"20 / 20 / 40",preview:this.createLayoutPreview("20-20-40","builder")},{id:"70-15-15",name:"Hero + Grid",preview:this.createLayoutPreview("70-15-15","builder")},{id:"60-20-20",name:"50 / 25 / 25",preview:this.createLayoutPreview("60-20-20","builder")},{id:"25-25-50-row",name:"25 / 25 / 50",preview:this.createLayoutPreview("25-25-50-row","builder")},{id:"irregular-6",name:"Pinterest Style (5)",preview:this.createLayoutPreview("irregular-6","builder")},{id:"two-row-6",name:"Two Row Grid (6)",preview:this.createLayoutPreview("two-row-6","builder")}].forEach(t=>{const s=document.createElement("div");s.className="layout-option",s.setAttribute("data-layout",t.id);const o=t.id.replace(/[^a-zA-Z0-9]/g,"-");s.innerHTML=`\n                    <div class="layout-option-preview layout-${o}">\n                        <div class="layout-preview">${t.preview}</div>\n                    </div>\n                    <div class="layout-option-name">${t.name}</div>\n                `,e.appendChild(s)}),e}addRowWithLayout(e){const t={100:{items:1},"50-50":{items:2},"50p-50l":{items:2},"25s-75l":{items:3},"67l-33l":{items:2},"33l-67l":{items:2},"67-left":{items:2},"67-right":{items:2},"33-33-33":{items:3},"50-25-25":{items:3},"25-25-50":{items:3},"25-50-25":{items:3},"20-40-40":{items:3},"40-40-20":{items:3},"40-20-20":{items:3},"20-20-40":{items:3},"25-25-25-25":{items:4},"70-15-15":{items:3},"40-30-30":{items:3},"60-20-20":{items:3},"25-25-50-row":{items:3},"irregular-6":{items:5},"two-row-6":{items:6}}[e];if(!t)return;const s={layout:e,items:[],fullWidth:!1,height:"medium",cropImages:!1};for(let o=0;o<t.items;o++){"67-left"===e&&1===o||"67-right"===e&&0===o?s.items.push({type:"empty",content:""}):s.items.push({type:"placeholder",background:`hsl(${60*o+30*Math.random()}, 70%, 60%)`,content:`Item ${o+1}`})}this.gridData.push(s),this.renderGrid(),this.renderAdminForm(),this.markAsChanged()}getLayoutName(e){return{100:"Single","50-50":"Half & Half","50p-50l":"Portrait + Landscape","25s-75l":"Stack + Landscape","67l-33l":"2/3 + 1/3","33l-67l":"1/3 + 2/3","67-left":"2/3 Left Aligned","67-right":"2/3 Right Aligned","33-33-33":"3 Columns","50-25-25":"Left + Stack","25-25-50":"Right + Stack","25-50-25":"Side + Center + Side","20-40-40":"20 / 40 / 40","40-40-20":"40 / 40 / 20","40-20-20":"40 / 20 / 20","20-20-40":"20 / 20 / 40","25-25-25-25":"4 Columns","70-15-15":"Hero + Grid","60-20-20":"50 / 25 / 25","25-25-50-row":"25 / 25 / 50","irregular-6":"Pinterest Style (5)","two-row-6":"Two Row Grid (6)"}[e]||"Unknown Layout"}createLayoutPreview(e,t="default"){const s="builder"===t?"layout-builder-item":"layout-preview-item";if("builder"===t){const t={100:`<div class="${s}" style="flex: 1;"></div>`,"50-50":`<div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div>`,"50p-50l":`<div class="${s}" style="flex: 1; height: 40px;"></div><div class="${s}" style="flex: 1; height: 25px;"></div>`,"25s-75l":`<div class="preview-left-stack" style="flex: 1; display: flex; flex-direction: column; gap: 5px;"><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div></div><div class="${s}" style="flex: 3;"></div>`,"67l-33l":`<div class="${s}" style="flex: 2;"></div><div class="${s}" style="flex: 1;"></div>`,"33l-67l":`<div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 2;"></div>`,"67-left":`<div class="${s}" style="flex: 2;"></div><div class="${s}" style="flex: 1; opacity: 0.3;"></div>`,"67-right":`<div class="${s}" style="flex: 1; opacity: 0.3;"></div><div class="${s}" style="flex: 2;"></div>`,"33-33-33":`<div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div>`,"50-25-25":`<div class="${s}" style="flex: 1;"></div><div class="preview-right-stack" style="flex: 1; display: flex; flex-direction: column; gap: 5px;"><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div></div>`,"25-25-50":`<div class="preview-left-stack" style="flex: 1; display: flex; flex-direction: column; gap: 5px;"><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div></div><div class="${s}" style="flex: 1;"></div>`,"25-50-25":`<div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 2;"></div><div class="${s}" style="flex: 1;"></div>`,"20-40-40":`<div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 2;"></div><div class="${s}" style="flex: 2;"></div>`,"40-40-20":`<div class="${s}" style="flex: 2;"></div><div class="${s}" style="flex: 2;"></div><div class="${s}" style="flex: 1;"></div>`,"25-25-25-25":`<div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div>`,"70-15-15":`<div class="${s}" style="flex: 7;"></div><div class="preview-right-stack" style="flex: 3; display: flex; flex-direction: column; gap: 2px;"><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div></div>`,"60-20-20":`<div class="${s}" style="flex: 2;"></div><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div>`,"25-25-50-row":`<div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 2;"></div>`,"irregular-6":`<div class="preview-irregular" style="display: grid; grid-template-columns: 2fr 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 5px; flex: 1;"><div class="${s}" style="grid-row: 1/3;"></div><div class="${s}"></div><div class="${s}"></div><div class="${s}"></div><div class="${s}"></div></div>`,"two-row-6":`<div class="preview-two-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 5px; flex: 1;"><div class="${s}" style="grid-column: 1/3; grid-row: 1;"></div><div class="${s}" style="grid-column: 3; grid-row: 1/3;"></div><div class="${s}" style="grid-column: 4; grid-row: 1;"></div><div class="${s}" style="grid-column: 1; grid-row: 2;"></div><div class="${s}" style="grid-column: 2; grid-row: 2;"></div><div class="${s}" style="grid-column: 4; grid-row: 2;"></div></div>`};return t[e]||t["50-50"]}{const t={100:`<div class="${s}" style="flex: 1;"></div>`,"50-50":`<div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div>`,"50p-50l":`<div class="${s}" style="flex: 1; height: 20px;"></div><div class="${s}" style="flex: 1; height: 12px;"></div>`,"25s-75l":`<div class="preview-left-stack" style="flex: 0 0 25%; display: flex; flex-direction: column; gap: 3px;"><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div></div><div class="${s}" style="flex: 1;"></div>`,"67l-33l":`<div class="${s}" style="flex: 2;"></div><div class="${s}" style="flex: 1;"></div>`,"33l-67l":`<div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 2;"></div>`,"67-left":`<div class="${s}" style="flex: 2;"></div><div class="${s}" style="flex: 1; opacity: 0.3;"></div>`,"67-right":`<div class="${s}" style="flex: 1; opacity: 0.3;"></div><div class="${s}" style="flex: 2;"></div>`,"33-33-33":`<div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div>`,"50-25-25":`<div class="${s}" style="flex: 1;"></div><div class="preview-right-stack" style="flex: 1; display: flex; flex-direction: column; gap: 5px;"><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div></div>`,"25-25-50":`<div class="preview-left-stack" style="flex: 1; display: flex; flex-direction: column; gap: 5px;"><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div></div><div class="${s}" style="flex: 1;"></div>`,"25-50-25":`<div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 2;"></div><div class="${s}" style="flex: 1;"></div>`,"20-40-40":`<div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 2;"></div><div class="${s}" style="flex: 2;"></div>`,"40-40-20":`<div class="${s}" style="flex: 2;"></div><div class="${s}" style="flex: 2;"></div><div class="${s}" style="flex: 1;"></div>`,"40-20-20":`<div class="${s}" style="flex: 2;"></div><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div>`,"20-20-40":`<div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 2;"></div>`,"25-25-25-25":`<div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div><div class="${s}" style="flex: 1;"></div>`,"70-15-15":`<div class="${s}" style="flex: 7; height: 20px;"></div><div class="preview-right-stack" style="flex: 3; display: flex; flex-direction: column; gap: 2px;"><div class="${s}" style="flex: 1; height: 14px;"></div><div class="${s}" style="flex: 1; height: 14px;"></div></div>`,"60-20-20":`<div class="${s}" style="flex: 2; height: 20px;"></div><div class="${s}" style="flex: 1; height: 20px;"></div><div class="${s}" style="flex: 1; height: 20px;"></div>`,"25-25-50-row":`<div class="${s}" style="flex: 1; height: 20px;"></div><div class="${s}" style="flex: 1; height: 20px;"></div><div class="${s}" style="flex: 2; height: 20px;"></div>`,"irregular-6":`<div class="preview-irregular" style="display: grid; grid-template-columns: 2fr 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 5px; flex: 1; height: 30px;"><div class="${s}" style="grid-row: 1/3;"></div><div class="${s}"></div><div class="${s}"></div><div class="${s}"></div><div class="${s}"></div></div>`,"two-row-6":`<div class="preview-two-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 5px; flex: 1; height: 30px;"><div class="${s}" style="grid-column: 1/3; grid-row: 1;"></div><div class="${s}" style="grid-column: 3; grid-row: 1/3;"></div><div class="${s}" style="grid-column: 4; grid-row: 1;"></div><div class="${s}" style="grid-column: 1; grid-row: 2;"></div><div class="${s}" style="grid-column: 2; grid-row: 2;"></div><div class="${s}" style="grid-column: 4; grid-row: 2;"></div></div>`};return t[e]||t["50-50"]}}createRowAccordion(e,t){const s=document.createElement("div");s.className="accordion-item",e.isDraft&&s.classList.add("draft-row"),s.setAttribute("data-row-index",t);const o=document.createElement("div");o.className="accordion-header";const i=this.createLayoutPreview(e.layout),n=this.getLayoutName(e.layout);o.innerHTML=`\n                <div class="accordion-header-content">\n                    <div class="layout-preview layout-${e.layout.replace(/[^a-zA-Z0-9]/g,"-")}">${i}</div>\n                    <span class="row-label">${n}${e.isDraft?" (draft)":""}</span>\n                </div>\n                <div class="row-controls">\n                    <div class="move-controls">\n                        <button class="row-move-btn row-move-up" data-row-index="${t}" data-direction="up" title="Move row up" ${0===t?"disabled":""}>\n                            <svg width="10" height="12" viewBox="0 0 10 12" fill="none" xmlns="http://www.w3.org/2000/svg">\n                                <path d="M5 11V1M5 1L1 5M5 1L9 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                            </svg>\n                        </button>\n                        <button class="row-move-btn row-move-down" data-row-index="${t}" data-direction="down" title="Move row down" ${t===this.gridData.length-1?"disabled":""}>\n                            <svg width="10" height="12" viewBox="0 0 10 12" fill="none" xmlns="http://www.w3.org/2000/svg" transform="rotate(180)">\n                                <path d="M5 11V1M5 1L1 5M5 1L9 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                            </svg>\n                        </button>\n                    </div>\n                    <div class="accordion-controls">\n                        <span class="accordion-arrow"></span>\n                        <button class="row-options-btn" data-row-index="${t}" title="Row options"></button>\n                    </div>\n                </div>\n            `;const a=document.createElement("div");a.className="accordion-content";const r=this.createRowForm(e,t);a.appendChild(r);const l=o.querySelector(".accordion-arrow");l&&l.addEventListener("mousedown",e=>{console.log("üñ±Ô∏è Accordion arrow clicked"),e.preventDefault(),e.stopPropagation(),this.preventSquarespaceInterference(e),this.toggleAccordion(s)});o.querySelector(".row-options-btn").addEventListener("mousedown",e=>{e.preventDefault(),e.stopPropagation(),this.showRowOptionsMenu(e,t)});const d=o.querySelector(".row-move-up"),c=o.querySelector(".row-move-down");return d&&d.addEventListener("mousedown",e=>{console.log("üéØ Move up button clicked"),e.preventDefault(),e.stopPropagation(),this.moveRowUp(t)}),c&&c.addEventListener("mousedown",e=>{console.log("üéØ Move down button clicked"),e.preventDefault(),e.stopPropagation(),this.moveRowDown(t)}),s.appendChild(o),s.appendChild(a),s}addItemDragListeners(e,t){e.querySelectorAll(".layout-area").forEach(e=>{if(e.querySelector(".empty-space-label"))return e.setAttribute("draggable","false"),void(e.style.cursor="default");e.setAttribute("data-drag-row-index",t),e.addEventListener("dragstart",t=>{t.stopPropagation();const s=parseInt(e.getAttribute("data-item-index")),o=parseInt(e.getAttribute("data-drag-row-index"));t.dataTransfer.setData("application/x-item-drag",JSON.stringify({rowIndex:o,itemIndex:s,sourceLayoutDisplay:e.closest(".layout-display")})),t.dataTransfer.effectAllowed="move",e.classList.add("dragging-item")}),e.addEventListener("dragend",t=>{t.stopPropagation(),e.classList.remove("dragging-item");e.closest(".layout-display").querySelectorAll(".layout-area").forEach(e=>e.classList.remove("drag-over-item"))}),e.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"}),e.addEventListener("dragenter",t=>{t.preventDefault(),t.target.closest(".layout-area")===e&&e.classList.add("drag-over-item")}),e.addEventListener("dragleave",t=>{e.contains(t.relatedTarget)||e.classList.remove("drag-over-item")}),e.addEventListener("drop",t=>{t.preventDefault();const s=t.dataTransfer.getData("application/x-item-drag");if(s){const t=JSON.parse(s),o=parseInt(e.getAttribute("data-item-index")),i=parseInt(e.getAttribute("data-drag-row-index"));t.rowIndex===i&&t.itemIndex!==o&&this.reorderItems(i,t.itemIndex,o)}e.classList.remove("drag-over-item")})})}reorderItems(e,t,s){if(t===s)return;const o=this.gridData[e];if(!o||!o.items)return;if(Array.isArray(o.items)||(o.items=[]),"empty"===o.items[t]?.type||"empty"===o.items[s]?.type)return void console.log("‚ùå Cannot swap with empty space items");const i=this.saveDetailedAccordionStates(),n=document.querySelector(".admin-panel-content")?.scrollTop||0,a=o.items[t];o.items[t]=o.items[s],o.items[s]=a,this.renderGrid(),this.renderAdminForm(),setTimeout(()=>{this.restoreDetailedAccordionStates(i);const e=document.querySelector(".admin-panel-content");e&&(e.scrollTop=n)},50),console.log(`‚úÖ Swapped items in row ${e}: ${t} ‚Üî ${s}`),this.markAsChanged()}createRowForm(e,t){const s=document.createElement("div");s.className="row-form";const o=document.createElement("div");o.className="row-top-controls",o.style.display="flex",o.style.gap="15px",o.style.alignItems="flex-end",o.style.marginBottom="20px";const i=document.createElement("div");i.className="form-group",i.style.flex="1",i.innerHTML=`\n                <label class="form-label">Layout</label>\n                <div class="visual-layout-selector" data-row-index="${t}">\n                    <div class="current-layout-display">\n                        <div class="layout-preview">${this.createLayoutPreview(e.layout)}</div>\n                        <span class="layout-name">${this.getLayoutName(e.layout)}</span>\n                        <span class="dropdown-arrow"></span>\n                    </div>\n                    <div class="layout-dropdown" id="layout-dropdown-${t}">\n                        ${this.createLayoutDropdownOptions(e.layout,t)}\n                    </div>\n                </div>\n            `,o.appendChild(i),s.appendChild(o);const n=document.createElement("div");n.className="layout-display",n.innerHTML=this.createVisualLayoutAreas(e,t),this.addItemDragListeners(n,t),s.appendChild(n);const a=document.createElement("div");a.className="row-bottom-controls",a.style.display="flex",a.style.gap="15px",a.style.alignItems="flex-end",a.style.marginTop="20px";const r=document.createElement("div");r.className="form-group",r.style.flex="1",r.innerHTML=`\n                <label class="form-label">Width</label>\n                <div class="full-width-toggle-container">\n                    <div class="toggle-switch ${e.fullWidth?"active":""}" data-row-index="${t}" data-toggle-type="fullWidth">\n                        <div class="toggle-switch-slider"></div>\n                        <span class="toggle-switch-label">Full Width</span>\n                    </div>\n                </div>\n            `;const l=document.createElement("div");l.className="form-group",l.style.flex="1",l.innerHTML=`\n                <label class="form-label">Height</label>\n                <select class="form-select height-selector" data-row-index="${t}">\n                    <option value="small" ${"small"===(e.height||"medium")?"selected":""}>Small</option>\n                    <option value="medium" ${"medium"===(e.height||"medium")?"selected":""}>Medium</option>\n                    <option value="large" ${"large"===(e.height||"medium")?"selected":""}>Large</option>\n                </select>\n            `,a.appendChild(r),a.appendChild(l),s.appendChild(a);const d=document.createElement("div");d.className="row-bottom-controls",d.style.display="flex",d.style.gap="15px",d.style.alignItems="flex-end",d.style.marginTop="15px";const c=document.createElement("div");c.className="form-group",c.style.flex="1";const u=void 0!==e.cropImages&&e.cropImages;return c.innerHTML=`\n                <label class="form-label">Image Fit</label>\n                <div class="crop-images-toggle-container">\n                    <div class="toggle-switch ${u?"active":""}" data-row-index="${t}" data-toggle-type="cropImages">\n                        <div class="toggle-switch-slider"></div>\n                        <span class="toggle-switch-label">Crop to Fill</span>\n                    </div>\n                </div>\n            `,d.appendChild(c),s.appendChild(d),s}createLayoutDropdownOptions(e,t){return[{id:"100",name:"Single"},{id:"50-50",name:"Half & Half"},{id:"50p-50l",name:"Portrait + Landscape"},{id:"25s-75l",name:"Stack + Landscape"},{id:"67l-33l",name:"2/3 + 1/3"},{id:"33l-67l",name:"1/3 + 2/3"},{id:"67-left",name:"2/3 Left Aligned"},{id:"67-right",name:"2/3 Right Aligned"},{id:"33-33-33",name:"3 Columns"},{id:"25-25-25-25",name:"4 Columns"},{id:"25-50-25",name:"Side + Center + Side"},{id:"50-25-25",name:"Left + Stack"},{id:"25-25-50",name:"Right + Stack"},{id:"20-40-40",name:"20 / 40 / 40"},{id:"40-40-20",name:"40 / 40 / 20"},{id:"40-20-20",name:"40 / 20 / 20"},{id:"20-20-40",name:"20 / 20 / 40"},{id:"70-15-15",name:"Hero + Grid"},{id:"60-20-20",name:"Asymmetric Emphasis"},{id:"irregular-6",name:"Pinterest Style (5)"},{id:"two-row-6",name:"Two Row Grid (6)"}].map(t=>`\n                <div class="layout-option-dropdown ${t.id===e?"selected":""}" \n                     data-layout="${t.id}">\n                    <div class="layout-preview">${this.createLayoutPreview(t.id)}</div>\n                    <span class="layout-name">${t.name}</span>\n                </div>\n            `).join("")}createLayoutAreaHTML(e,t,s,o=null){const i=e.items[s]||{type:"placeholder",content:o||`Item ${s+1}`},n=i&&"video"===i.type,a=n&&i.previewVideo;return`\n                <div class="layout-area-wrapper">\n                    <div class="layout-area" draggable="true" data-row-index="${t}" data-item-index="${s}" data-drag-row-index="${t}">\n                        <div class="drag-handle">‚ãÆ‚ãÆ</div>\n                        <div class="area-content">\n                            ${this.getAreaContentDisplay(i)}\n                        </div>\n                        ${this.createAreaOverlay(t,s,i)}\n                    </div>\n                    ${n?`\n                        <div class="preview-video-controls">\n                            <div class="toggle-switch ${a||i.showPreviewUpload?"active":""}" \n                                 data-row-index="${t}" \n                                 data-item-index="${s}"\n                                 data-toggle-type="previewVideo">\n                                <div class="toggle-switch-slider"></div>\n                                <span class="toggle-switch-label">Use Preview Video</span>\n                            </div>\n                            ${a||i.showPreviewUpload?`\n                                <div class="preview-video-upload-area" data-row="${t}" data-item="${s}">\n                                    ${i.previewVideo?this.getPreviewVideoThumbnail(i.previewVideo,t,s):`\n                                        <button class="preview-video-select-btn" data-row="${t}" data-item="${s}">\n                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>\n                                            </svg>\n                                            <span>Select Preview Video</span>\n                                        </button>\n                                    `}\n                                </div>\n                            `:""}\n                        </div>\n                    `:""}\n                </div>\n            `}createVisualLayoutAreas(e,t){const s={100:{items:1},"50-50":{items:2},"50p-50l":{items:2},"25s-75l":{items:3},"67l-33l":{items:2},"33l-67l":{items:2},"67-left":{items:2},"67-right":{items:2},"33-33-33":{items:3},"50-25-25":{items:3},"25-25-50":{items:3},"25-50-25":{items:3},"20-40-40":{items:3},"40-40-20":{items:3},"40-20-20":{items:3},"20-20-40":{items:3},"25-25-25-25":{items:4},"70-15-15":{items:3},"40-30-30":{items:3},"60-20-20":{items:3},"25-25-50-row":{items:3},"irregular-6":{items:5},"two-row-6":{items:6}}[e.layout];if(!s)return"";let o='<div class="visual-layout-areas layout-'+e.layout+'">';if("50-25-25"===e.layout)o+=this.createLayoutAreaHTML(e,t,0,"Item 1"),o+='<div class="admin-right-stack">',o+=this.createLayoutAreaHTML(e,t,1,"Item 2"),o+=this.createLayoutAreaHTML(e,t,2,"Item 3"),o+="</div>";else if("25-25-50"===e.layout)o+='<div class="admin-left-stack">',o+=this.createLayoutAreaHTML(e,t,0,"Item 1"),o+=this.createLayoutAreaHTML(e,t,1,"Item 2"),o+="</div>",o+=this.createLayoutAreaHTML(e,t,2,"Item 3");else if("70-15-15"===e.layout)o+=this.createLayoutAreaHTML(e,t,0,"Feature"),o+='<div class="admin-right-stack">',o+=this.createLayoutAreaHTML(e,t,1,"Small 1"),o+=this.createLayoutAreaHTML(e,t,2,"Small 2"),o+="</div>";else if("irregular-6"===e.layout)o+=this.createLayoutAreaHTML(e,t,0,"Feature"),o+=this.createLayoutAreaHTML(e,t,1,"Item 2"),o+=this.createLayoutAreaHTML(e,t,2,"Item 3"),o+=this.createLayoutAreaHTML(e,t,3,"Item 4"),o+=this.createLayoutAreaHTML(e,t,4,"Item 5");else if("two-row-6"===e.layout)o+=this.createLayoutAreaHTML(e,t,0,"Hero"),o+=this.createLayoutAreaHTML(e,t,1,"Tall"),o+=this.createLayoutAreaHTML(e,t,2,"Top"),o+=this.createLayoutAreaHTML(e,t,3,"Left"),o+=this.createLayoutAreaHTML(e,t,4,"Right"),o+=this.createLayoutAreaHTML(e,t,5,"Bottom");else for(let i=0;i<s.items;i++)o+=this.createLayoutAreaHTML(e,t,i);return o+="</div>",o}getAreaContentDisplay(e){if("empty"===e.type)return'<div class="empty-space-label" style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999; font-size: 12px; opacity: 0.5;">Empty Space</div>';if("image"===e.type&&e.content)return`<img src="${e.content}" alt="Layout item" style="width: 100%; height: 100%; object-fit: cover;">`;if("video"===e.type&&e.content){const t=`admin-video-${Math.random().toString(36).substr(2,9)}`;return setTimeout(async()=>{const s={assetUrl:e.content},o=await this.getVideoThumbnail(s),i=document.getElementById(t);i&&(o?(i.style.backgroundImage=`url(${o})`,i.style.backgroundSize="cover",i.style.backgroundPosition="center",i.innerHTML='<div class="video-thumbnail-overlay"><svg width="38" height="38" viewBox="0 0 38 38" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_35469_18153)"><path d="M1.8999 18.9999C1.8999 28.444 9.55584 36.0999 18.9999 36.0999C28.444 36.0999 36.0999 28.444 36.0999 18.9999C36.0999 9.55584 28.444 1.8999 18.9999 1.8999C9.55584 1.8999 1.8999 9.55584 1.8999 18.9999Z" stroke="white" stroke-width="3.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M15.2 24.7V13.3L24.7 19L15.2 24.7Z" stroke="white" stroke-width="3.8" stroke-linecap="round" stroke-linejoin="round"/></g><defs><clipPath id="clip0_35469_18153"><rect width="38" height="38" fill="white"/></clipPath></defs></svg></div>'):(i.style.background="#f0f0f0",i.innerHTML='<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 24px; color: #666;"><svg width="38" height="38" viewBox="0 0 38 38" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_35469_18153)"><path d="M1.8999 18.9999C1.8999 28.444 9.55584 36.0999 18.9999 36.0999C28.444 36.0999 36.0999 28.444 36.0999 18.9999C36.0999 9.55584 28.444 1.8999 18.9999 1.8999C9.55584 1.8999 1.8999 9.55584 1.8999 18.9999Z" stroke="#666" stroke-width="3.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M15.2 24.7V13.3L24.7 19L15.2 24.7Z" stroke="#666" stroke-width="3.8" stroke-linecap="round" stroke-linejoin="round"/></g><defs><clipPath id="clip0_35469_18153"><rect width="38" height="38" fill="white"/></clipPath></defs></svg></div>'))},100),`<div id="${t}" class="video-thumbnail-container" style="width: 100%; height: 100%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #666;">Loading thumbnail...</div>`}return`<div class="placeholder-content">${e.content||"Empty"}</div>`}getPreviewVideoThumbnail(e,t,s){const o=`preview-video-${t}-${s}`;return setTimeout(async()=>{const t={assetUrl:e},s=await this.getVideoThumbnail(t),i=document.getElementById(o);i&&(s?(i.style.backgroundImage=`url(${s})`,i.style.backgroundSize="cover",i.style.backgroundPosition="center",i.innerHTML=""):(i.style.background="#666",i.innerHTML='<div style="color: white; font-size: 11px;">No thumbnail</div>'))},100),`\n                <div class="preview-video-thumbnail">\n                    <div id="${o}" style="width: 100%; height: 100%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 4px;">\n                        <span style="font-size: 11px; color: #999;">Loading...</span>\n                    </div>\n                    <button class="preview-video-remove" data-row="${t}" data-item="${s}">√ó</button>\n                </div>\n            `}createAreaOverlay(e,t,s=null){if(s&&"empty"===s.type)return"";return`\n                <div class="area-overlay">\n                    <button class="area-menu-btn" data-row="${e}" data-item="${t}" title="Media options">\n                        <svg width="31" height="20" viewBox="0 0 31 20" fill="none" xmlns="http://www.w3.org/2000/svg">\n                            <path d="M1.00005 16.0001C1 15.9355 1 15.8689 1 15.8002V4.2002C1 3.08009 1 2.51962 1.21799 2.0918C1.40973 1.71547 1.71547 1.40973 2.0918 1.21799C2.51962 1 3.08009 1 4.2002 1H15.8002C16.9203 1 17.4801 1 17.9079 1.21799C18.2842 1.40973 18.5905 1.71547 18.7822 2.0918C19 2.5192 19 3.07899 19 4.19691V15.8031C19 16.2881 19 16.6679 18.9822 16.9774M1.00005 16.0001C1.00082 16.9884 1.01337 17.5058 1.21799 17.9074C1.40973 18.2837 1.71547 18.5905 2.0918 18.7822C2.5192 19 3.07899 19 4.19691 19H15.8036C16.9215 19 17.4805 19 17.9079 18.7822C18.2842 18.5905 18.5905 18.2837 18.7822 17.9074C18.9055 17.6654 18.959 17.3813 18.9822 16.9774M1.00005 16.0001L5.76798 10.4375L5.76939 10.436C6.19227 9.9426 6.40406 9.69551 6.65527 9.60645C6.87594 9.52821 7.11686 9.53004 7.33643 9.61133C7.58664 9.70397 7.79506 9.95387 8.21191 10.4541L10.8831 13.6595C11.269 14.1226 11.463 14.3554 11.6986 14.4489C11.9065 14.5313 12.1357 14.5406 12.3501 14.4773C12.5942 14.4053 12.8091 14.1904 13.2388 13.7607L13.7358 13.2637C14.1733 12.8262 14.3921 12.6076 14.6397 12.5361C14.8571 12.4734 15.0896 12.4869 15.2988 12.5732C15.537 12.6716 15.7302 12.9124 16.1167 13.3955L18.9822 16.9774M18.9822 16.9774L19 16.9996M13 7C12.4477 7 12 6.55228 12 6C12 5.44772 12.4477 5 13 5C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                            <path d="M24 10H30M27 13V7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                        </svg>\n                    </button>\n                    <div class="area-context-menu" data-row="${e}" data-item="${t}">\n                        <button class="area-menu-item area-btn-library" data-row="${e}" data-item="${t}">\n                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n                                <path d="M13 14C13 14.5523 13.4477 15 14 15C14.5523 15 15 14.5523 15 14C15 13.4477 14.5523 13 14 13C13.4477 13 13 13.4477 13 14Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                                <path d="M7 14C7 14.5523 7.44772 15 8 15C8.55228 15 9 14.5523 9 14C9 13.4477 8.55228 13 8 13C7.44772 13 7 13.4477 7 14Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                                <path d="M1 14C1 14.5523 1.44772 15 2 15C2.55228 15 3 14.5523 3 14C3 13.4477 2.55228 13 2 13C1.44772 13 1 13.4477 1 14Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                                <path d="M13 8C13 8.55228 13.4477 9 14 9C14.5523 9 15 8.55228 15 8C15 7.44772 14.5523 7 14 7C13.4477 7 13 7.44772 13 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                                <path d="M7 8C7 8.55228 7.44772 9 8 9C8.55228 9 9 8.55228 9 8C9 7.44772 8.55228 7 8 7C7.44772 7 7 7.44772 7 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                                <path d="M1 8C1 8.55228 1.44772 9 2 9C2.55228 9 3 8.55228 3 8C3 7.44772 2.55228 7 2 7C1.44772 7 1 7.44772 1 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                                <path d="M13 2C13 2.55228 13.4477 3 14 3C14.5523 3 15 2.55228 15 2C15 1.44772 14.5523 1 14 1C13.4477 1 13 1.44772 13 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                                <path d="M7 2C7 2.55228 7.44772 3 8 3C8.55228 3 9 2.55228 9 2C9 1.44772 8.55228 1 8 1C7.44772 1 7 1.44772 7 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                                <path d="M1 2C1 2.55228 1.44772 3 2 3C2.55228 3 3 2.55228 3 2C3 1.44772 2.55228 1 2 1C1.44772 1 1 1.44772 1 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                            </svg>\n                            <span>Select from Library</span>\n                        </button>\n                        <button class="area-menu-item area-btn-upload" data-row="${e}" data-item="${t}">\n                            <svg width="16" height="20" viewBox="0 0 16 20" fill="none" xmlns="http://www.w3.org/2000/svg">\n                                <path d="M8 16V13M8 13V10M8 13H5M8 13H11M9 1.00087C8.90451 1 8.79728 1 8.67471 1H4.2002C3.08009 1 2.51962 1 2.0918 1.21799C1.71547 1.40973 1.40973 1.71547 1.21799 2.0918C1 2.51962 1 3.08009 1 4.2002V15.8002C1 16.9203 1 17.4801 1.21799 17.9079C1.40973 18.2842 1.71547 18.5905 2.0918 18.7822C2.51921 19 3.079 19 4.19694 19L11.8031 19C12.921 19 13.48 19 13.9074 18.7822C14.2837 18.5905 14.5905 18.2842 14.7822 17.9079C15 17.4805 15 16.9215 15 15.8036V7.32568C15 7.20296 15 7.09561 14.9991 7M9 1.00087C9.28564 1.00347 9.46634 1.01385 9.63884 1.05526C9.84291 1.10425 10.0379 1.18526 10.2168 1.29492C10.4186 1.41857 10.5918 1.59182 10.9375 1.9375L14.063 5.06298C14.4089 5.40889 14.5809 5.58136 14.7046 5.78319C14.8142 5.96214 14.8953 6.15726 14.9443 6.36133C14.9857 6.53376 14.9963 6.71451 14.9991 7M9 1.00087V3.8C9 4.9201 9 5.47977 9.21799 5.90759C9.40973 6.28392 9.71547 6.59048 10.0918 6.78223C10.5192 7 11.079 7 12.1969 7H14.9991M14.9991 7H15.0002" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                            </svg>\n                            <span>Upload File</span>\n                        </button>\n                        ${s&&"placeholder"!==s.type&&s.content?`\n                            <button class="area-menu-item area-btn-remove" data-row="${e}" data-item="${t}">\n                                <svg width="16" height="18" viewBox="0 0 16 18" fill="none" xmlns="http://www.w3.org/2000/svg">\n                                    <path d="M6 1H10M2 4H14M12.6667 4L12.1991 11.0129C12.129 12.065 12.0939 12.5911 11.8667 12.99C11.6666 13.3412 11.3648 13.6235 11.0011 13.7998C10.588 14 10.0607 14 9.00623 14H6.99377C5.93927 14 5.41202 14 4.99889 13.7998C4.63517 13.6235 4.33339 13.3412 4.13332 12.99C3.90607 12.5911 3.871 12.065 3.80086 11.0129L3.33333 4M6.66667 7.5V10.5M9.33333 7.5V10.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                                </svg>\n                                <span>Remove Media</span>\n                            </button>\n                        `:""}\n                    </div>\n                </div>\n            `}toggleLayoutDropdown(e){const t=document.getElementById(`layout-dropdown-${e}`),s=t.closest(".visual-layout-selector").querySelector(".dropdown-arrow"),o=t.classList.contains("open");document.querySelectorAll(".layout-dropdown").forEach(e=>{e.classList.remove("open");e.closest(".visual-layout-selector").querySelector(".dropdown-arrow").style.transform="rotate(0deg)"}),o||(t.classList.add("open"),s.style.transform="rotate(180deg)")}selectLayoutFromDropdown(e,t){this.updateRowLayout(t,e);const s=document.getElementById(`layout-dropdown-${t}`);if(s){s.querySelectorAll(".layout-option-dropdown").forEach(e=>{e.classList.remove("selected")});const t=s.querySelector(`[data-layout="${e}"]`);t&&t.classList.add("selected")}const o=document.querySelector(`.visual-layout-selector[data-row-index="${t}"]`);if(o){const t=o.querySelector(".layout-preview"),s=o.querySelector(".layout-name");t&&(t.innerHTML=this.createLayoutPreview(e)),s&&(s.textContent=this.getLayoutName(e))}const i=document.querySelector(`.accordion-item[data-row-index="${t}"]`);if(i){const s=i.querySelector(".accordion-header .layout-preview"),o=i.querySelector(".accordion-header .row-label");if(s&&(s.innerHTML=this.createLayoutPreview(e)),o){const s=this.getLayoutName(e),i=this.gridData[t]&&this.gridData[t].isDraft;o.textContent=`${s}${i?" (draft)":""}`}}const n=document.getElementById(`layout-dropdown-${t}`);n&&n.classList.contains("open")&&this.toggleLayoutDropdown(t)}async selectFromLibrary(e,t){document.querySelector(".asset-modal-overlay")?.remove(),this.showAssetSelectorDrawer(null,e,t);try{const s=this.getCdnEdgeToken();if(!s)throw new Error("Could not get authentication token. Ensure logged into Squarespace admin.");const o=await this.getWebsiteId(s);if(!o)throw new Error("Could not determine website ID.");if(!await this.checkExistingMediaAccess(o)){const e=await this.getAssetLibraryAuth(s);if(!e)throw new Error("Could not get asset library authorization token.");this.assetLibraryToken=e.token;const t=await this.getAssetAuth(s);t&&t.token&&(this.assetAuthToken=t.token,console.log("üé¨ Got asset authorization token for video playback from library"))}const i=await this.listAssetLibraryMedia(o,s,{limit:500});if(0===i.length)throw new Error("No media assets found in your asset library.");this.updateAssetDrawerContent(i,e,t)}catch(e){this.showAssetDrawerError(e.message),console.error("Asset library error:",e)}}uploadFile(e,t){this.uploadNewImage(e,t)}uploadToAssetLibrary(){console.log("üé¨ Starting upload to asset library...");const e=document.createElement("input");e.type="file",e.accept="image/*,video/*",e.style.display="none",e.onchange=async t=>{const s=t.target.files[0];if(s){console.log(`üé¨ Selected file for library: ${s.name}`);try{const e=s.type.startsWith("video/")?"video":"image",t=this.createUploadingPlaceholder(s.name,e);this.addUploadPlaceholderToLibrary(t);const o=this.getCdnEdgeToken();if(!o)throw new Error("Could not retrieve CSRF token.");const i=await this.getWebsiteId(o);if(!i)throw new Error("Could not retrieve Website ID.");if(!this.assetAuthToken){const e=await this.getAssetAuth(o);e&&e.token&&(this.assetAuthToken=e.token,console.log("üé¨ Got asset authorization token for video playback"))}const n=s.type.startsWith("video/"),a=await this.uploadRawMediaFile(s,i);if(!a)throw new Error(`Failed to upload raw ${n?"video":"image"} file.`);const r=await this.pollForAssetId(a,n);if(!r)throw new Error("Failed to get asset ID after upload.");let l;if(n){console.log("Video upload complete! Constructing asset info directly..."),l={id:r,assetUrl:`https://video.squarespace-cdn.com/content/v1/${i}/${r}/{variant}`},console.log("üé¨ üìö Activating newly uploaded video via lesson service...");try{await this.performFauxSectionSave(r,o,s.name)}catch(e){console.warn("üé¨ ‚ö†Ô∏è  Video activation failed, but upload was successful:",e)}}else if(l=await this.referenceAssetInLibrary(r,i,o,n),!l)throw new Error("Failed to reference asset in library.");this.replaceUploadPlaceholderWithAsset(t,l,s.name,n),console.log("üé¨ Upload to library complete!")}catch(e){console.error("Upload to library failed:",e),document.querySelector(".upload-placeholder")?.remove(),alert("Upload failed: "+e.message)}finally{document.body.removeChild(e)}}else document.body.removeChild(e)},document.body.appendChild(e),e.click()}createUploadingPlaceholder(e,t){const s=document.createElement("div");return s.className="asset-grid-item upload-placeholder",s.innerHTML=`\n                <div class="asset-thumbnail">\n                    <div class="upload-progress">\n                        <div class="loading-spinner"></div>\n                        <div class="upload-status">\n                            <div class="upload-text">Uploading ${t}...</div>\n                            <div class="upload-filename">${e}</div>\n                        </div>\n                    </div>\n                </div>\n                <div class="asset-info">\n                    <p class="asset-filename">${e}</p>\n                </div>\n            `,s}addUploadPlaceholderToLibrary(e){const t=document.querySelector(".asset-drawer .asset-grid");t&&t.insertBefore(e,t.firstChild)}replaceUploadPlaceholderWithAsset(e,t,s,o){if(!e||!e.parentNode)return;const i=document.createElement("div"),n=o?"video-asset":"image-asset",a=document.querySelector(".asset-drawer"),r=parseInt(a.dataset.rowIndex),l=parseInt(a.dataset.itemIndex),d={assetUrl:t.assetUrl,assetType:o?"VIDEO":"IMAGE",filename:s,stringMetaData:{fileName:s},title:s,id:t.id};this.currentMediaAssets&&(this.currentMediaAssets.unshift(d),this.filteredAssets&&this.filteredAssets.unshift(d)),i.className=`asset-grid-item ${n}`,i.setAttribute("data-asset-index","0"),i.setAttribute("data-row-index",r),i.setAttribute("data-item-index",l);const c=o?t.assetUrl.replace("{variant}","poster"):t.assetUrl,u=o?'<div class="video-play-overlay">\n                <svg width="16" height="18" viewBox="0 0 16 18" fill="none" xmlns="http://www.w3.org/2000/svg">\n                    <path d="M1 14.3336V3.66698C1 2.78742 1 2.34715 1.18509 2.08691C1.34664 1.85977 1.59564 1.71064 1.87207 1.67499C2.18868 1.63415 2.57701 1.84126 3.35254 2.25487L13.3525 7.58821L13.3562 7.58982C14.2132 8.04692 14.642 8.27557 14.7826 8.58033C14.9053 8.84619 14.9053 9.15308 14.7826 9.41894C14.6418 9.72413 14.212 9.95371 13.3525 10.4121L3.35254 15.7454C2.57645 16.1593 2.1888 16.3657 1.87207 16.3248C1.59564 16.2891 1.34664 16.1401 1.18509 15.9129C1 15.6527 1 15.2132 1 14.3336Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                </svg>\n            </div>':"";i.innerHTML=`\n                <div class="asset-thumbnail">\n                    <img src="${c}" alt="${s}" loading="lazy">\n                    ${u}\n                </div>\n                <div class="asset-info">\n                    <span class="asset-filename">${s}</span>\n                </div>\n            `,e.parentNode.replaceChild(i,e);document.querySelector(".asset-drawer .asset-grid").querySelectorAll(".asset-grid-item:not(.upload-placeholder)").forEach((e,t)=>{e!==i&&e.setAttribute("data-asset-index",t)})}async refreshAssetLibrary(){const e=document.querySelector(".asset-drawer");if(!e)return;const t=parseInt(e.dataset.rowIndex),s=parseInt(e.dataset.itemIndex);this.assetCache=null,await this.filterAndSortAssets(e,t,s)}uploadNewImage(e,t){document.querySelector(".asset-modal-overlay")?.remove(),console.log("üé¨ Starting SAFE file upload process for:",e,t);const s=document.createElement("input");s.type="file",s.accept="image/*,video/*",s.style.display="none",s.onchange=async o=>{const i=o.target.files[0];if(i){console.log(`üé¨ Selected file: ${i.name}`);try{const s=i.type.startsWith("video/")?"video":"image",o=this.createLoadingOverlay(`Uploading ${s}...`);document.body.appendChild(o);const n=this.getCdnEdgeToken();if(!n)throw new Error("Could not retrieve CSRF token.");const a=await this.getWebsiteId(n);if(!a)throw new Error("Could not retrieve Website ID.");if(!this.assetAuthToken){const e=await this.getAssetAuth(n);e&&e.token&&(this.assetAuthToken=e.token,console.log("üé¨ Got asset authorization token for video playback"))}const r=i.type.startsWith("video/"),l=await this.uploadRawMediaFile(i,a);if(!l)throw new Error(`Failed to upload raw ${r?"video":"image"} file.`);const d=await this.pollForAssetId(l,r);if(!d)throw new Error("Failed to get asset ID after upload.");let c;if(r){console.log("Video upload complete! Constructing asset info directly..."),c={id:d,assetUrl:`https://video.squarespace-cdn.com/content/v1/${a}/${d}/{variant}`},console.log("üé¨ üìö Activating newly uploaded video via lesson service...");try{await this.performFauxSectionSave(d,n,i.name)}catch(e){console.warn("üé¨ ‚ö†Ô∏è  Video activation failed, but upload was successful:",e)}}else if(c=await this.referenceAssetInLibrary(d,a,n,r),!c)throw new Error("Failed to reference asset in library.");const u=i.type.startsWith("video/")?"video":"image";this.gridData[e].items[t]={type:u,content:c.assetUrl};const m=this.saveDetailedAccordionStates(),h=document.querySelector(".admin-left-column")?.scrollTop||0;this.renderGrid(),this.renderAdminForm(),this.markAsChanged(),setTimeout(()=>{this.restoreDetailedAccordionStates(m);const e=document.querySelector(".admin-left-column");e&&(e.scrollTop=h)},50),o.remove(),console.log(`${u.charAt(0).toUpperCase()+u.slice(1)} uploaded successfully!`,c)}catch(e){console.error("Upload failed:",e),alert(`Upload failed: ${e.message}`),document.querySelector(".upload-loading-overlay")?.remove()}document.body.removeChild(s)}else document.body.removeChild(s)},s.onerror=()=>{document.body.removeChild(s)},document.body.appendChild(s),setTimeout(()=>{try{s.click()}catch(e){console.error("File input click failed:",e);const t=new MouseEvent("click",{bubbles:!1,cancelable:!0});s.dispatchEvent(t)}},0)}uploadPreviewVideo(e,t){console.log("üé¨ Starting preview video upload for:",e,t);const s=document.createElement("input");s.type="file",s.accept="video/*",s.style.display="none",s.onchange=async o=>{const i=o.target.files[0];if(i){if(!i.type.startsWith("video/"))return alert("Please select a video file for the preview."),void document.body.removeChild(s);console.log(`üé¨ Selected preview video: ${i.name}`);try{const s=this.createLoadingOverlay("Uploading preview video...");document.body.appendChild(s);const o=this.getCdnEdgeToken();if(!o)throw new Error("Could not retrieve CSRF token.");const n=await this.getWebsiteId(o);if(!n)throw new Error("Could not retrieve Website ID.");if(!this.assetAuthToken){const e=await this.getAssetAuth(o);e&&e.token&&(this.assetAuthToken=e.token,console.log("üé¨ Got asset authorization token for preview video"))}const a=await this.uploadRawMediaFile(i,n);if(!a)throw new Error("Failed to upload raw video file.");const r=await this.pollForAssetId(a,!0);if(!r)throw new Error("Failed to get asset ID after upload.");console.log("Preview video upload complete! Constructing asset info...");const l={id:r,assetUrl:`https://video.squarespace-cdn.com/content/v1/${n}/${r}/{variant}`};console.log("üé¨ üìö Activating preview video via lesson service...");try{await this.performFauxSectionSave(r,o,i.name)}catch(e){console.warn("üé¨ ‚ö†Ô∏è  Preview video activation failed, but upload was successful:",e)}this.gridData[e]&&this.gridData[e].items[t]&&(this.gridData[e].items[t].previewVideo=l.assetUrl);const d=this.saveDetailedAccordionStates(),c=document.querySelector(".admin-left-column")?.scrollTop||0;this.renderGrid(),this.renderAdminForm(),this.markAsChanged(),setTimeout(()=>{this.restoreDetailedAccordionStates(d);const e=document.querySelector(".admin-left-column");e&&(e.scrollTop=c)},50),s.remove(),console.log("Preview video uploaded successfully!",l)}catch(e){console.error("Preview video upload failed:",e),alert(`Preview video upload failed: ${e.message}`),document.querySelector(".upload-loading-overlay")?.remove()}document.body.removeChild(s)}else document.body.removeChild(s)},s.onerror=()=>{document.body.removeChild(s)},document.body.appendChild(s),setTimeout(()=>{try{s.click()}catch(e){console.error("File input click failed:",e);const t=new MouseEvent("click",{bubbles:!1,cancelable:!0});s.dispatchEvent(t)}},0)}removeImage(e,t){if(!this.gridData[e]||!this.gridData[e].items)return;const s=this.saveDetailedAccordionStates(),o=document.querySelector(".admin-left-column")?.scrollTop||0;this.gridData[e].items[t]={type:"placeholder",content:`Item ${t+1}`},this.renderGrid(),this.renderAdminForm(),this.markAsChanged(),setTimeout(()=>{this.restoreDetailedAccordionStates(s);const e=document.querySelector(".admin-left-column");e&&(e.scrollTop=o)},50)}toggleAreaContextMenu(e,t,s){this.closeAllAreaContextMenus();const o=document.querySelector(`.area-context-menu[data-row="${e}"][data-item="${t}"]`);if(!o)return;const i=s.target.closest(".area-menu-btn").closest(".layout-area").getBoundingClientRect(),n=i.left+i.width/2,a=i.top+i.height/2;o.style.position="fixed",o.style.left=`${n}px`,o.style.top=`${a}px`,o.style.transform="translate(-50%, -50%)",o.style.zIndex="10000",o.classList.add("active")}closeAllAreaContextMenus(){document.querySelectorAll(".area-context-menu.active").forEach(e=>{e.classList.remove("active")})}sleep(e){return new Promise(t=>setTimeout(t,e))}async getWebsiteId(e){console.log("Attempting to retrieve Website ID...");try{const t=`${window.location.origin}/api/commondata/GetCollections`,s=await fetch(t,{method:"GET",headers:{accept:"application/json, text/plain, */*","x-csrf-token":e},credentials:"include"});if(!s.ok)throw new Error(`Failed to fetch collections data: ${s.status} ${s.statusText}`);const o=await s.json();if(o&&o.collections&&Object.keys(o.collections).length>0){const e=Object.keys(o.collections)[0],t=o.collections[e].websiteId;if(t)return console.log(`Website ID successfully retrieved: ${t}`),t}return console.error("Could not find websiteId within the GetCollections response."),null}catch(e){return console.error("Error retrieving Website ID:",e),null}}async uploadRawMediaFile(e,t){const s=e.type.startsWith("video/")?"video":"image";console.log(`Step 1: Uploading raw ${s} "${e.name}" to media-api.squarespace.com/uploads/${s}...`);try{const o=new FormData;o.append("image",e,e.name);const i=await fetch(`https://media-api.squarespace.com/uploads/${s}`,{method:"POST",headers:{accept:"application/json, text/plain, */*","x-library-id":t,"x-sqsp-source":"web upload"},body:o,credentials:"include",mode:"cors"});if(!i.ok)throw new Error(`Raw ${s} upload failed: HTTP status ${i.status}. Response: ${await i.text()}`);const n=await i.json();return console.log(`Step 1 successful! ${s.charAt(0).toUpperCase()+s.slice(1)} Job Info:`,n),n&&n.jobId?n.jobId:(console.warn(`Step 1 response did not contain expected jobId. Full ${s} response:`,n),null)}catch(e){return console.error("Error during Step 1 (raw media upload):",e),null}}async pollForAssetId(e,t=!1){const s=t?"video":"image";console.log(`Step 2: Polling for ${s} asset ID...`);const o=t?3e3:1e3,i=t?1/0:30;let n=0;for(;n<i;){await this.sleep(o),n++,console.log(`Polling attempt ${n}...`);try{const t=`https://media-api.squarespace.com/jobs/${s}/status?job-list=${encodeURIComponent(e)}`,o=await fetch(t,{method:"GET",headers:{accept:"application/json, text/plain, */*"},credentials:"omit",mode:"cors"});if(!o.ok){console.warn(`Polling status failed: HTTP status ${o.status}. Retrying...`);continue}const i=await o.json();if(Array.isArray(i)&&i.length>0){const t=i.find(t=>t.id===e);if(t){if(!0===t.isSuccess&&3===t.status&&t.assetId)return console.log(`Step 2 successful! Job completed, received assetId: ${t.assetId}`),t.assetId;if((!1===t.isSuccess||3!==t.status)&&t.error)throw new Error(`Job processing failed with error: ${t.error.message||"Unknown error"}`)}else console.warn("Job ID not found in polling response array. Continuing to poll...")}else console.warn("Unexpected polling response structure. Continuing to poll...")}catch(e){console.error("Error during Step 2 (polling for asset ID):",e)}}return t?console.error(`Step 2 failed: Video processing appears to have failed after ${n} attempts.`):console.error(`Step 2 failed: Max polling attempts (${i}) reached. Asset ID not found.`),null}async referenceAssetInLibrary(e,t,s,o=!1){const i=o?"video":"image";console.log(`Step 3: Referencing ${i} asset ID "${e}" in asset library...`);try{const i={assetId:e,libraryId:t,recordType:o?10:2},n=o?"videos":"images",a=`${window.location.origin}/api/uploads/${n}/asset-reference?crumb=${encodeURIComponent(s)}`,r=await fetch(a,{method:"POST",headers:{accept:"application/json, text/plain, */*","content-type":"application/x-www-form-urlencoded","x-csrf-token":s,"x-requested-with":"XMLHttpRequest"},body:new URLSearchParams(i),credentials:"include",mode:"cors"});if(!r.ok){if(o&&404===r.status)return console.log("Video asset reference endpoint not found (404) - this may be expected for videos"),null;throw new Error(`Asset reference failed: HTTP status ${r.status}. Response: ${await r.text()}`)}const l=await r.json(),d=l.media&&l.media.length>0?l.media[0]:null;return d&&d.id&&d.assetUrl?(console.log("Step 3 successful! Asset is now referenced and available in library."),d):(console.warn("Step 3 response did not contain expected asset ID or assetUrl in result.media[0]. Full response:",l),null)}catch(e){return console.error("Error during Step 3 (asset reference):",e),null}}createLoadingOverlay(e){const t=document.createElement("div");t.className="upload-loading-overlay",t.style.cssText="\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0, 0, 0, 0.7);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 10000;\n                color: white;\n                font-family: system-ui, -apple-system, sans-serif;\n                font-size: 18px;\n            ";const s=document.createElement("div");if(s.style.cssText="\n                background: #333;\n                padding: 30px;\n                border-radius: 8px;\n                text-align: center;\n                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);\n            ",s.innerHTML=`\n                <div style="margin-bottom: 15px;">\n                    <div style="width: 40px; height: 40px; border: 3px solid #555; border-top: 3px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>\n                </div>\n                <div>${e}</div>\n            `,!document.querySelector("#upload-spinner-styles")){const e=document.createElement("style");e.id="upload-spinner-styles",e.textContent="\n                    @keyframes spin {\n                        0% { transform: rotate(0deg); }\n                        100% { transform: rotate(360deg); }\n                    }\n                ",document.head.appendChild(e)}return t.appendChild(s),t}createLoadingModal(e){const t=document.createElement("div");return t.className="asset-modal-overlay",t.innerHTML=`\n                <div class="asset-modal loading-modal">\n                    <div class="loading-spinner"></div>\n                    <p class="loading-message">${e}</p>\n                </div>\n            `,t}updateLoadingModal(e,t){const s=e.querySelector(".loading-message");s&&(s.textContent=t)}showErrorModal(e,t){const s=document.createElement("div");s.className="asset-modal-overlay",s.innerHTML=`\n                <div class="asset-modal error-modal">\n                    <div class="asset-modal-header">\n                        <h3>${e}</h3>\n                        <button class="asset-modal-close" >‚úï</button>\n                    </div>\n                    <div class="asset-modal-content">\n                        <p>${t}</p>\n                        <button class="btn btn-primary" >OK</button>\n                    </div>\n                </div>\n            `,document.body.appendChild(s)}showAssetSelectorDrawer(e,t,s){this.currentMediaAssets=e,this.filteredAssets=e?this.sortAssets(e,"date-desc"):e;const o=document.createElement("div");o.className="asset-drawer-overlay",o.innerHTML=`\n                <div class="asset-drawer" data-row-index="${t}" data-item-index="${s}">\n                    <div class="asset-drawer-header">\n                        <h3>Select Media from Asset Library</h3>\n                        <div class="asset-drawer-header-actions">\n                            <button class="asset-drawer-upload" title="Upload New Image">\n                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                                    <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                                    <path d="M7 10L12 5L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                                    <path d="M12 5V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                                </svg>\n                                Upload\n                            </button>\n                            <button class="asset-drawer-close" >‚úï</button>\n                        </div>\n                    </div>\n                    <div class="asset-drawer-controls">\n                        <div class="search-container">\n                            <input type="text" class="asset-search" placeholder="Search by filename or keywords..." />\n                            <div class="search-icon">\n                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">\n                                    <path d="M13 13L19 19M8 15C4.13401 15 1 11.866 1 8C1 4.13401 4.13401 1 8 1C11.866 1 15 4.13401 15 8C15 11.866 11.866 15 8 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                                </svg>\n                            </div>\n                        </div>\n                        <div class="filter-container">\n                            <select class="asset-filter">\n                                <option value="all">All Media</option>\n                                <option value="image">Images Only</option>\n                                <option value="video">Videos Only</option>\n                                <option value="unused">Unused in Gallery</option>\n                                <option value="used">Used in Gallery</option>\n                            </select>\n                        </div>\n                        <div class="sort-container">\n                            <select class="asset-sort">\n                                <option value="date-desc">Newest First</option>\n                                <option value="date-asc">Oldest First</option>\n                                <option value="name-asc">Name (A-Z)</option>\n                                <option value="name-desc">Name (Z-A)</option>\n                            </select>\n                        </div>\n                        <div class="results-count">\n                            <span class="asset-count">${e?e.length:0} assets</span>\n                        </div>\n                    </div>\n                    <div class="asset-drawer-content">\n                        <div class="asset-grid">\n                            ${e?this.createAssetGrid(this.filteredAssets,t,s):this.createSkeletonLoaders()}\n                        </div>\n                    </div>\n                </div>\n            `,document.body.appendChild(o),this.setupAssetLibraryNuclearLockdown(o),requestAnimationFrame(()=>{o.classList.add("show")}),e&&this.setupAssetFiltering(o,t,s),this.setupAssetSelectionMousedownHandlers(o,t,s),o.addEventListener("click",e=>{e.target===o&&this.closeAssetDrawer(o)})}setupAssetLibraryNuclearLockdown(e){console.log("üõ°Ô∏è Setting up NUCLEAR lockdown for asset library...");["click","dblclick"].forEach(e=>{document.addEventListener(e,t=>{const s=t.target;if(s&&s.closest(".asset-drawer-overlay"))return console.log(`üõ°Ô∏è BLOCKING ${e} event in asset drawer:`,s),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1},!0)}),console.log("‚úÖ NUCLEAR lockdown for asset library complete")}setupAssetSelectionMousedownHandlers(e,t,s){console.log("üñ±Ô∏è Setting up mousedown handlers for asset drawer controls...");const o=e.querySelector(".asset-drawer-close");o&&o.addEventListener("mousedown",t=>{t.preventDefault(),t.stopPropagation(),console.log("üñ±Ô∏è Asset drawer close button mousedown"),this.closeAssetDrawer(e)});const i=e.querySelector(".asset-drawer-upload");i&&i.addEventListener("mousedown",e=>{e.preventDefault(),e.stopPropagation(),console.log("üñ±Ô∏è Asset drawer upload button mousedown"),this.uploadToAssetLibrary()}),console.log("‚úÖ Asset drawer mousedown handlers setup complete")}setupAssetFiltering(e,t,s){const o=e.querySelector(".asset-search"),i=e.querySelector(".asset-filter"),n=e.querySelector(".asset-sort"),a=e.querySelector(".asset-grid");e.querySelector(".asset-count");let r;o.addEventListener("input",()=>{clearTimeout(r),r=setTimeout(()=>{this.filterAndSortAssets(e,t,s)},300)}),i.addEventListener("change",()=>this.filterAndSortAssets(e,t,s)),n.addEventListener("change",()=>this.filterAndSortAssets(e,t,s)),a.addEventListener("click",n=>{n.target.classList.contains("clear-search-btn")&&(o.value="",i.value="all",this.filterAndSortAssets(e,t,s))})}filterAndSortAssets(e,t,s){const o=e.querySelector(".asset-search").value.toLowerCase(),i=e.querySelector(".asset-filter").value,n=e.querySelector(".asset-sort").value,a=e.querySelector(".asset-grid"),r=e.querySelector(".asset-count");if(!this.currentMediaAssets)return;let l=this.currentMediaAssets.filter(e=>{const t=(e.stringMetaData?.fileName||e.filename||"").toLowerCase(),s=(e.title||e.stringMetaData?.title||"").toLowerCase(),n=!o||t.includes(o)||s.includes(o),a="VIDEO"===e.assetType?"video":"image";let r=!0;return"image"===i||"video"===i?r=i===a:"used"===i?r=this.isAssetUsedInGallery(e):"unused"===i?r=!this.isAssetUsedInGallery(e):"all"===i&&(r=!0),n&&r});l=this.sortAssets(l,n),this.filteredAssets=l,a.innerHTML=l.length>0?this.createAssetGrid(l,t,s):this.createNoResultsMessage(o,i),r.textContent=`${l.length} asset${1!==l.length?"s":""}`}sortAssets(e,t){return[...e].sort((e,s)=>{switch(t){case"name-asc":const t=(e.stringMetaData?.fileName||e.filename||"").toLowerCase(),o=(s.stringMetaData?.fileName||s.filename||"").toLowerCase();return t.localeCompare(o);case"name-desc":const i=(e.stringMetaData?.fileName||e.filename||"").toLowerCase();return(s.stringMetaData?.fileName||s.filename||"").toLowerCase().localeCompare(i);case"date-desc":const n=new Date(e.createdAt||e.createdOn||e.modifiedOn||e.uploadedOn||e.dateCreated||e.dateModified||0);return new Date(s.createdAt||s.createdOn||s.modifiedOn||s.uploadedOn||s.dateCreated||s.dateModified||0)-n;case"date-asc":return new Date(e.createdAt||e.createdOn||e.modifiedOn||e.uploadedOn||e.dateCreated||e.dateModified||0)-new Date(s.createdAt||s.createdOn||s.modifiedOn||s.uploadedOn||s.dateCreated||s.dateModified||0);default:return 0}})}isAssetUsedInGallery(e){if(!this.gridData||!e.assetUrl)return!1;for(const t of this.gridData)if(t.items)for(const s of t.items){if(s.content&&s.content===e.assetUrl)return!0;if(s.content&&this.normalizeAssetUrl(s.content)===this.normalizeAssetUrl(e.assetUrl))return!0}return!1}normalizeAssetUrl(e){return e?e.split("?")[0]:""}createNoResultsMessage(e,t){let s;switch(t){case"video":s="videos";break;case"image":s="images";break;case"used":s="used assets";break;case"unused":s="unused assets";break;default:s="assets"}return`\n                <div class="no-results-message">\n                    <div class="no-results-icon">üîç</div>\n                    <h4>No Results Found</h4>\n                    <p>${e?`No ${s} found matching "${e}"`:`No ${s} found`}</p>\n                    <button class="clear-search-btn">Clear Search</button>\n                </div>\n            `}createSkeletonLoaders(){return Array.from({length:12},(e,t)=>`\n                    <div class="asset-grid-item skeleton-loader ${Math.random()>.7?"skeleton-wide":""}">\n                        <div class="skeleton-thumbnail"></div>\n                        <div class="asset-info">\n                            <div class="skeleton-title"></div>\n                            <div class="skeleton-filename"></div>\n                        </div>\n                    </div>\n                `).join("")}updateAssetDrawerContent(e,t,s){this.currentMediaAssets=e,this.filteredAssets=e;const o=document.querySelector(".asset-drawer-overlay");if(!o)return;const i=o.querySelector(".asset-grid"),n=o.querySelector(".asset-count");i&&(i.innerHTML=this.createAssetGrid(e,t,s)),n&&(n.textContent=`${e.length} asset${1!==e.length?"s":""}`),this.setupAssetFiltering(o,t,s)}showAssetDrawerError(e){const t=document.querySelector(".asset-drawer .asset-grid");t&&(t.innerHTML=`\n                    <div class="asset-error-state">\n                        <div class="error-icon">‚ö†Ô∏è</div>\n                        <h4>Error Loading Assets</h4>\n                        <p>${e}</p>\n                        <button class="retry-button" onclick="location.reload()">Retry</button>\n                    </div>\n                `)}closeAssetDrawer(e){e.classList.remove("show"),setTimeout(()=>{e.remove()},300)}createAssetGrid(e,t,s){return e.map((e,o)=>{const i="VIDEO"===e.assetType,n=e.stringMetaData?.fileName||e.filename||"Untitled",a=(e.title||e.stringMetaData,i?`asset-video-${o}-${Math.random().toString(36).substr(2,9)}`:"");let r;i?(r="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZjBmMGYwIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgZmlsbD0iIzk5OSIgZm9udC1zaXplPSIxNCI+TG9hZGluZy4uLjwvdGV4dD4KPC9zdmc+",setTimeout(async()=>{const t=await this.getVideoThumbnail(e),s=document.getElementById(a);s&&t&&(s.src=t,console.log(`üé¨ Asset library thumbnail loaded: ${t} for ${n}`))},10)):(r=e.assetUrl,r.includes("?format=original")?r=r.replace("?format=original","?format=300w"):r.includes("?")?r+="&format=300w":r+="?format=300w");return`\n                    <div class="asset-grid-item ${i?"video-asset":"image-asset"}" data-asset-index="${o}" data-row-index="${t}" data-item-index="${s}">\n                        <div class="asset-thumbnail">\n                            <img ${a?`id="${a}"`:""} src="${r}" alt="${n}" loading="lazy">\n                            ${i?'<div class="video-play-overlay">\n                    <svg width="16" height="18" viewBox="0 0 16 18" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M1 14.3336V3.66698C1 2.78742 1 2.34715 1.18509 2.08691C1.34664 1.85977 1.59564 1.71064 1.87207 1.67499C2.18868 1.63415 2.57701 1.84126 3.35254 2.25487L13.3525 7.58821L13.3562 7.58982C14.2132 8.04692 14.642 8.27557 14.7826 8.58033C14.9053 8.84619 14.9053 9.15308 14.7826 9.41894C14.6418 9.72413 14.212 9.95371 13.3525 10.4121L3.35254 15.7454C2.57645 16.1593 2.1888 16.3657 1.87207 16.3248C1.59564 16.2891 1.34664 16.1401 1.18509 15.9129C1 15.6527 1 15.2132 1 14.3336Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                    </svg>\n                </div>':""}\n                        </div>\n                        <div class="asset-info">\n                            <span class="asset-filename">${n}</span>\n                        </div>\n                    </div>\n                `}).join("")}async selectAsset(e,t,s){const o=document.querySelector(".asset-drawer-overlay");o&&this.closeAssetDrawer(o);const i=this.uploadingPreviewVideo&&this.uploadingPreviewVideo.rowIndex===t&&this.uploadingPreviewVideo.itemIndex===s,n="VIDEO"===e.assetType,a=n?"video":"image";let r=e.assetUrl;const l=e.stringMetaData?.fileName||e.filename||"Untitled";if(n){console.log("üé¨ Processing video for storage:",r),console.log("üé¨ üìö Adding video to lesson collection for permanent access...");try{const t=this.getCrumbToken();t?await this.performFauxSectionSave(e.id,t,l):console.log("üé¨ ‚ö†Ô∏è  No CSRF token found, skipping lesson collection addition")}catch(e){console.error("üé¨ ‚ùå Failed to add video to lesson collection:",e)}if("PRIVATE"===e.protectionLevel){console.log("üé¨ üîê Private video detected, authorizing for public access...");try{const t=await this.authorizePrivateVideo(e);t&&t.accessibleVideoUrl&&(r=t.accessibleVideoUrl,console.log(`üé¨ üîì Using accessible video URL: ${r}`)),console.log("üé¨ ‚úÖ Video authorized successfully")}catch(e){console.error("üé¨ ‚ùå Failed to authorize video:",e)}}}console.log(`Storing ${a} URL:`,r),console.log(`Full ${a} data:`,e),console.log(`${a.charAt(0).toUpperCase()+a.slice(1)} URL:`,r),i?(console.log(`üìπ Storing as preview video for row ${t}, item ${s}`),this.gridData[t]&&this.gridData[t].items[s]&&(this.gridData[t].items[s].previewVideo=r,this.gridData[t].items[s].showPreviewUpload=!0),this.uploadingPreviewVideo=null,this.renderAdminForm(),this.markAsChanged()):(this.updateItemType(t,s,a),this.updateItemContent(t,s,r),n&&this.updateItemMetadata(t,s,{assetData:e,defaultThumbnail:e.defaultThumbnail,thumbnails:e.thumbnails})),console.log(`Selected ${a}: ${l} for row ${t}, item ${s}`)}updateSpecificRowInAdmin(e){const t=document.querySelector(`[data-row-index="${e}"]`);if(!t)return;if(t.classList.contains("expanded")){const s=t.querySelector(".accordion-content");if(s&&this.gridData[e]){const t=this.gridData[e],o=this.createRowForm(t,e);s.innerHTML="",s.appendChild(o)}}}toggleAccordion(e){const t=e.querySelector(".accordion-content");e.classList.contains("expanded")?(e.classList.remove("expanded"),t.classList.remove("active")):(document.querySelectorAll(".accordion-item").forEach(e=>{e.classList.remove("expanded"),e.querySelector(".accordion-content").classList.remove("active")}),e.classList.add("expanded"),t.classList.add("active"))}removeRow(e){confirm("Are you sure you want to remove this row?")&&(this.gridData.splice(e,1),this.renderGrid(),this.renderAdminForm(),this.markAsChanged())}updateRowLayout(e,t){if(this.gridData[e]){this.storeRowImagesTemporarily(e),this.gridData[e].layout=t;const s={100:{items:1},"50-50":{items:2},"50p-50l":{items:2},"25s-75l":{items:3},"67l-33l":{items:2},"33l-67l":{items:2},"67-left":{items:2},"67-right":{items:2},"33-33-33":{items:3},"50-25-25":{items:3},"25-25-50":{items:3},"25-50-25":{items:3},"20-40-40":{items:3},"40-40-20":{items:3},"40-20-20":{items:3},"20-20-40":{items:3},"25-25-25-25":{items:4},"70-15-15":{items:3},"60-20-20":{items:3},"25-25-50-row":{items:3},"irregular-6":{items:5},"two-row-6":{items:6}}[t];if(s){const o=[],i=this.gridData[e].layout,n=this.gridData[e].items||[];if("67-left"===i&&"67-right"===t||"67-right"===i&&"67-left"===t)if("67-left"===t){const e=n.find(e=>e&&"empty"!==e.type);o[0]=e||{type:"placeholder",background:"#667eea",content:"Item 1"},o[1]={type:"empty",content:""}}else{const e=n.find(e=>e&&"empty"!==e.type);o[0]={type:"empty",content:""},o[1]=e||{type:"placeholder",background:"#667eea",content:"Item 2"}}else for(let i=0;i<s.items;i++){if("67-left"===t&&1===i||"67-right"===t&&0===i)o[i]={type:"empty",content:""};else{const t=this.getStoredImageForPosition(e,i);if(t&&"empty"!==t.type)o[i]=t;else{const e=n[i];e&&"empty"!==e.type?o[i]=e:o[i]={type:"placeholder",background:`hsl(${60*i}, 70%, 60%)`,content:`Item ${i+1}`}}}}this.gridData[e].items=o}this.updateRowLayoutAreas(e),this.markAsChanged()}}updateRowLayoutAreas(e){const t=document.querySelector(`.accordion-item[data-row-index="${e}"]`);if(!t)return;const s=t.querySelector(".layout-display");if(s){const t=this.gridData[e];s.innerHTML=this.createVisualLayoutAreas(t,e),this.addItemDragListeners(s,e)}this.renderGrid()}storeRowImagesTemporarily(e){this.tempRowImages[e]||(this.tempRowImages[e]={});(this.gridData[e].items||[]).forEach((t,s)=>{t&&"placeholder"!==t.type&&(this.tempRowImages[e][s]=JSON.parse(JSON.stringify(t)))}),console.log(`üì¶ Stored ${Object.keys(this.tempRowImages[e]).length} images temporarily for row ${e}`)}getStoredImageForPosition(e,t){if(this.tempRowImages[e]&&this.tempRowImages[e][t]){const s=this.tempRowImages[e][t];return console.log(`üì¶ Restored image from temporary storage for row ${e}, item ${t}`),s}return null}clearTempRowImages(e=null){null!==e?(delete this.tempRowImages[e],console.log(`üì¶ Cleared temporary storage for row ${e}`)):(this.tempRowImages={},console.log("üì¶ Cleared all temporary storage"))}updateItemType(e,t,s){this.gridData[e]&&this.gridData[e].items[t]&&(this.gridData[e].items[t].type=s,this.renderGrid(),this.updateSpecificRowInAdmin(e),this.markAsChanged())}updateItemContent(e,t,s){this.gridData[e]&&this.gridData[e].items[t]&&(this.gridData[e].items[t].content=s,this.renderGrid(),this.updateSpecificRowInAdmin(e),this.markAsChanged())}updateItemMetadata(e,t,s){this.gridData[e]&&this.gridData[e].items[t]&&(this.gridData[e].items[t].metadata=s,this.renderGrid(),this.updateSpecificRowInAdmin(e),this.markAsChanged())}updateItemBackground(e,t,s){this.gridData[e]&&this.gridData[e].items[t]&&(this.gridData[e].items[t].background=s,this.renderGrid(),this.markAsChanged())}renderGrid(){this.masonryGrid&&(this.masonryGrid.innerHTML="",this.gridData.forEach((e,t)=>{if(e.isDraft)return;const s=document.createElement("div");s.className=`masonry-row layout-${e.layout}`,e.fullWidth&&s.classList.add("full-width");void 0===e.cropImages||e.cropImages?s.classList.add("crop-images"):s.classList.add("no-crop-images");const o=e.height||"medium";if(s.classList.add(`height-${o}`),"50-25-25"===e.layout){if(e.items[0]){const o=this.createMasonryItem(e.items[0],0,t,e.layout);s.appendChild(o)}const o=document.createElement("div");if(o.className="masonry-right-stack",e.items[1]){const s=this.createMasonryItem(e.items[1],1,t,e.layout);o.appendChild(s)}if(e.items[2]){const s=this.createMasonryItem(e.items[2],2,t,e.layout);o.appendChild(s)}s.appendChild(o)}else if("25-25-50"===e.layout){const o=document.createElement("div");if(o.className="masonry-left-stack",e.items[0]){const s=this.createMasonryItem(e.items[0],0,t,e.layout);o.appendChild(s)}if(e.items[1]){const s=this.createMasonryItem(e.items[1],1,t,e.layout);o.appendChild(s)}if(s.appendChild(o),e.items[2]){const o=this.createMasonryItem(e.items[2],2,t,e.layout);s.appendChild(o)}}else if("70-15-15"===e.layout){if(e.items[0]){const o=this.createMasonryItem(e.items[0],0,t,e.layout);s.appendChild(o)}const o=document.createElement("div");if(o.className="masonry-right-stack",e.items[1]){const s=this.createMasonryItem(e.items[1],1,t,e.layout);o.appendChild(s)}if(e.items[2]){const s=this.createMasonryItem(e.items[2],2,t,e.layout);o.appendChild(s)}s.appendChild(o)}else if("irregular-6"===e.layout){if(e.items[0]){const o=this.createMasonryItem(e.items[0],0,t,e.layout);s.appendChild(o)}const o=document.createElement("div");o.className="masonry-right-grid";for(let s=1;s<5;s++)if(e.items[s]){const i=this.createMasonryItem(e.items[s],s,t,e.layout);o.appendChild(i)}s.appendChild(o)}else if("25s-75l"===e.layout){const o=document.createElement("div");if(o.className="masonry-left-stack",e.items[0]){const s=this.createMasonryItem(e.items[0],0,t,e.layout);o.appendChild(s)}if(e.items[1]){const s=this.createMasonryItem(e.items[1],1,t,e.layout);o.appendChild(s)}if(s.appendChild(o),e.items[2]){const o=this.createMasonryItem(e.items[2],2,t,e.layout);s.appendChild(o)}}else e.items.forEach((o,i)=>{const n=this.createMasonryItem(o,i,t,e.layout);s.appendChild(n)});this.masonryGrid.appendChild(s)}))}createMasonryItem(e,t,s,o=null){const i=document.createElement("div");if(i.className="masonry-item","empty"===e.type)return i.classList.add("empty-space"),i.style.background="transparent",i.style.pointerEvents="none",i;if("placeholder"===e.type)i.classList.add("placeholder"),i.style.backgroundColor=e.background||"#667eea",i.textContent=e.content||`Item ${t+1}`;else if("image"===e.type&&e.content){const t=document.createElement("img");t.src=e.content,t.className="masonry-item-image",t.style.width="100%",t.style.display="block",t.style.borderRadius="inherit",t.style.height="100%",t.style.objectFit="cover",i.appendChild(t)}else if("video"===e.type&&e.content){const t=document.createElement("video");t.controls=!1,t.muted=!0,t.autoplay=!0,t.loop=!0,t.playsInline=!0;const s=document.querySelector(".masonry-container");s&&s.classList.contains("no-crop")||(t.style.width="100%",t.style.height="100%",t.style.objectFit="cover"),t.style.pointerEvents="none";const o=e.previewVideo||e.content;if(this.getVideoPlaylistUrl(o)!==o||o.includes(".m3u8"))if("undefined"==typeof Hls){const s=document.createElement("script");s.src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js",s.onload=()=>{this.setupHLSVideo(t,o,!0,e.metadata)},document.head.appendChild(s)}else this.setupHLSVideo(t,o,!0,e.metadata);else t.src=o;if(i.appendChild(t),!this.isAdminMode){const e=document.createElement("div");e.className="video-play-icon",e.innerHTML='\n                        <svg width="48" height="48" viewBox="0 0 38 38" fill="none" xmlns="http://www.w3.org/2000/svg">\n                            <g clip-path="url(#clip0_video_play)">\n                                <path d="M1.8999 18.9999C1.8999 28.444 9.55584 36.0999 18.9999 36.0999C28.444 36.0999 36.0999 28.444 36.0999 18.9999C36.0999 9.55584 28.444 1.8999 18.9999 1.8999C9.55584 1.8999 1.8999 9.55584 1.8999 18.9999Z" stroke="white" stroke-width="3.8" stroke-linecap="round" stroke-linejoin="round"/>\n                                <path d="M15.2 24.7V13.3L24.7 19L15.2 24.7Z" fill="white" stroke="white" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>\n                            </g>\n                            <defs>\n                                <clipPath id="clip0_video_play">\n                                    <rect width="38" height="38" fill="white"/>\n                                </clipPath>\n                            </defs>\n                        </svg>\n                    ',i.appendChild(e)}}return"placeholder"===e.type||"image"!==e.type&&"video"!==e.type||!e.content||void 0===s||(i.style.cursor="pointer",i.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.openLightbox(s,t)})),i}async loadExternalConfig(){try{const e=document.head.querySelectorAll("meta");let t=null;for(const s of e)if("masonry-grid"===s.getAttribute("squarehero-plugin")){const e=s.getAttribute("license-key");t=atob(e);break}if(!t)return console.log("üìù No external configuration found, using empty grid"),null;console.log("üîó Loading configuration from:",t);const s=await fetch(t);if(!s.ok)throw new Error(`Failed to fetch configuration: ${s.status}`);const o=await s.json();return console.log("‚úÖ External configuration loaded successfully"),o}catch(e){return console.error("‚ùå Error loading external configuration:",e),null}}async loadWidgetData(){try{console.log("üì• Starting data load process..."),console.log("üÜî Current section ID:",this.sectionId);const e=await this.loadExternalConfig();if(e&&e[this.sectionId]){console.log("üìä Using external configuration data");const t=e[this.sectionId];this.gridData=t.rows||[],this.currentLayout=t.layout||"layout-5050",this.accordionEnabled=t.accordion||!1,this.styleSettings=t.styleSettings||{rowGap:50,itemGap:50,mobileRowGap:30,mobileItemGap:20,borderRadius:8,shadow:"none",hoverEffect:"scale"},void 0===this.styleSettings.mobileRowGap&&(this.styleSettings.mobileRowGap=30),void 0===this.styleSettings.mobileItemGap&&(this.styleSettings.mobileItemGap=20),console.log("üîß Loaded gridData:",this.gridData),console.log("üé® Layout:",this.currentLayout)}else console.log("üìù No data found for section, using default"),this.gridData=[{layout:"50-50",items:[{type:"placeholder",background:"#667eea",content:"Sample Item 1"},{type:"placeholder",background:"#f093fb",content:"Sample Item 2"}]}],this.currentLayout="layout-5050",this.accordionEnabled=!1,this.styleSettings={rowGap:50,itemGap:50,borderRadius:8,shadow:"none",hoverEffect:"scale"};this.renderGrid(),this.updateStyles(),console.log("‚úÖ Widget data loaded and rendered successfully")}catch(e){console.error("‚ùå Error loading widget data:",e),this.showError("Failed to load grid data. Please refresh the page.")}}showError(e){this.container.innerHTML=`\n                <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">\n                    <h3 style="color: #dc3545; margin-bottom: 15px;">‚ö†Ô∏è Error</h3>\n                    <p style="color: #666; margin-bottom: 20px;">${e}</p>\n                    <button id="retry-btn" class="btn btn-primary">Retry</button>\n                </div>\n            `;document.getElementById("retry-btn").addEventListener("click",()=>this.loadWidgetData())}markAsChanged(){this.hasUnsavedChanges=!0,this.showAdminFooter("You have unsaved changes","changes")}showAdminFooter(e,t="info",s=!1){this.adminStatus.textContent=e,this.adminStatus.className=`admin-status ${t}`,this.adminStatus.style.display="block",this.adminSaveBtn.style.display="inline-block",this.adminDiscardBtn.style.display="inline-block",this.adminFooter.classList.add("show"),s||"success"!==t||setTimeout(()=>{this.hideAdminFooter()},3e3)}hideAdminFooter(){this.adminStatus.style.display="none",this.adminSaveBtn.style.display="none",this.adminDiscardBtn.style.display="none",this.adminFooter.classList.remove("show")}discardChanges(){this.gridData=JSON.parse(JSON.stringify(this.originalData)),this.clearTempRowImages(),this.renderGrid(),this.renderAdminForm(),this.hasUnsavedChanges=!1,this.hideAdminFooter()}handleAdminClose(){this.hasUnsavedChanges?this.showAdminFooter("You have unsaved changes! Please save or discard them before closing.","changes",!0):this.toggleAdminMode()}handleBackdropClick(){this.hasUnsavedChanges?(this.shakeFooter(),this.showAdminFooter("You have unsaved changes! Please save or discard them before closing.","changes",!0)):this.toggleAdminMode()}shakeFooter(){this.adminFooter&&(this.adminFooter.classList.remove("shake"),this.adminFooter.offsetHeight,this.adminFooter.classList.add("shake"),setTimeout(()=>{this.adminFooter.classList.remove("shake")},600))}async saveConfiguration(){try{this.showAdminFooter("Saving configuration...","loading",!1);const e=this.serializeGridConfiguration();console.log("üìÑ Configuration to save:",e);let t={};try{const e=document.querySelector('meta[squarehero-plugin="masonry-grid"]');if(e){const s=atob(e.getAttribute("license-key"));console.log("üîç Found existing config URL:",s);const o=await fetch(s);if(o.ok){t=await o.json()}else console.log("üìù No existing config found, creating new"),t={}}else t={}}catch(e){console.log("üìù Could not load existing config, starting fresh:",e.message),t={}}console.log("üîß Full config before update:",t),this.sectionId?(t[this.sectionId]=e,console.log("üìä Section data saved:",t[this.sectionId])):t=e,console.log("üéØ Final config to save:",t);const s=JSON.stringify(t,null,2),o=new Blob([s],{type:"application/json"}),i=this.getCdnEdgeToken();if(!i)throw new Error("CDN edge token required - please refresh and try again");await this.removeExistingMasonryConfig(i);const n=new FormData,a=btoa("masonry-manifest.json")+".json";n.append("file",o,a);const r=await fetch(`${window.location.origin}/api/uploads/css-assets`,{method:"POST",headers:{"x-csrf-token":i},body:n,credentials:"include"});if(!r.ok)throw new Error(`Upload failed: ${r.status} ${r.statusText}`);const l=await r.json();console.log("üì§ Upload result:",l);let d=null;if(l.media&&l.media.length>0){const e=l.media[0];d=e.staticUrl||e.url||e.assetUrl}else d=l.staticUrl||l.url||l.assetUrl;if(!d)throw new Error("No URL returned from upload");console.log("üîó Config uploaded to:",d);await this.updateConfigReference(d)?(this.originalData=JSON.parse(JSON.stringify(this.gridData)),this.hasUnsavedChanges=!1,this.clearTempRowImages(),this.showAdminFooter("Configuration saved successfully!","success",!1),setTimeout(()=>{this.hideAdminFooter()},2e3)):this.showAdminFooter("Failed to save configuration. Please try again.","error",!0)}catch(e){console.error("Save error:",e),this.showAdminFooter("Error saving configuration: "+e.message,"error",!0)}}serializeGridConfiguration(){const e=this.adminForm?this.adminForm.querySelector('select[name="layout"]'):null,t=e?e.value:"layout-5050",s=[];return this.gridData&&Array.isArray(this.gridData)&&this.gridData.forEach((e,t)=>{e.items&&Array.isArray(e.items)&&e.items.forEach((e,o)=>{s.push({id:e.id||`row-${t}-item-${o}`,content:e.content||"",imageUrl:e.imageUrl||"",title:e.title||"",description:e.description||"",type:e.type||"image",rowIndex:t,itemIndex:o})})}),0===s.length&&s.push({id:"default-item-1",content:"Sample content",imageUrl:"https://via.placeholder.com/400x300",title:"Sample Item",description:"This is a sample masonry grid item",type:"image",rowIndex:0,itemIndex:0}),{layout:t,accordion:!1,rows:this.gridData||[],items:s,styleSettings:this.styleSettings||{rowGap:50,itemGap:50,mobileRowGap:30,mobileItemGap:20,borderRadius:8,shadow:"none",hoverEffect:"scale"},version:"1.0.0",lastModified:(new Date).toISOString()}}async removeExistingMasonryConfig(e){try{const t=await this.apiRequest("/api/v1/commerce-preferences/onboarding",e);if(!t?.websiteId)return!1;const s=t.websiteId,o="5c5a519771c10ba3470d8101",i=`https://${window.location.host}/api/template/GetTemplateCSSAssets?templateId=${o}&websiteId=${s}&recordType=16`,n=await this.apiRequest(i,e);if(!n?.assets)return!1;const a=btoa("masonry-manifest.json")+".json",r=n.assets.filter(e=>e.filename===a);if(0===r.length)return!1;const l=`https://${window.location.host}/api/template/RemoveTemplateCSSAsset`;let d=0;for(const t of r)try{const i={templateId:o,websiteId:s,itemId:t.id};null!==await this.apiRequest(l,e,"POST",i,!0)&&(d++,console.log(`üóëÔ∏è Removed old config: ${t.filename}`))}catch(e){console.warn(`‚ö†Ô∏è Failed to remove config ${t.filename}:`,e.message)}return console.log(`üßπ Cache cleanup complete: ${d} files removed`),d>0}catch(e){return console.warn("‚ö†Ô∏è Cache cleanup failed:",e.message),!1}}async updateConfigReference(e){try{const t=this.getCdnEdgeToken();if(!t)return!1;const s=await this.apiRequest(window.location.origin+"/api/config/GetInjectionSettings",t);if(!s)return!1;const o='\x3c!-- Masonry Grid plugin by SquareHero.store - Do not remove --\x3e\n<meta squarehero-plugin="masonry-grid" license-key="'+btoa(e)+'">';let i=s.header||"";const n=new RegExp("\x3c!--\\s*Masonry Grid plugin by SquareHero\\.store[^>]*>\\s*\\n?\\s*<meta\\s+squarehero-plugin=[\"']?(masonry-grid)[\"']?[^>]*>","gi");i=i.replace(n,"");const a=new RegExp("\x3c!--\\s*Masonry Grid plugin by SquareHero\\.store[^>]*>","gi");i=i.replace(a,""),i=i.replace(/\n\s*\n\s*\n/g,"\n\n"),i=i.replace(/^\s*\n+/,""),i=i.trim(),i?i+="\n"+o:i=o;const r=new URLSearchParams({header:i,footer:s.footer||"",lockPage:s.lockPage||"",postItem:s.postItem||""});return(await fetch(window.location.origin+"/api/config/SaveInjectionSettings",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded","x-csrf-token":t},credentials:"include",body:r})).ok}catch(e){return!1}}async apiRequest(e,t,s="GET",o=null,i=!1){const n={method:s,headers:{accept:"application/json, text/plain, */*","x-csrf-token":t},credentials:"include"};o&&(i?(n.headers["Content-Type"]="application/x-www-form-urlencoded",n.body=new URLSearchParams(o).toString()):(n.headers["Content-Type"]="application/json",n.body=JSON.stringify(o)));const a=await fetch(e,n);return a.ok?await a.json():null}getCdnEdgeToken(){const e=document.cookie.split(";").find(e=>e.trim().startsWith("crumb="));return e?e.split("=")[1]:null}async getWebsiteId(e){try{const t=await fetch("/api/commondata/GetCollections",{method:"GET",headers:{accept:"application/json, text/plain, */*","x-csrf-token":e},credentials:"include"});if(!t.ok)throw new Error(`Failed to get website ID (HTTP status ${t.status})`);const s=await t.json();if(s.collections){const e=Object.keys(s.collections)[0];if(e&&s.collections[e].websiteId)return s.collections[e].websiteId}throw new Error("Website ID not found in GetCollections response data.")}catch(e){return console.error("Error getting Website ID:",e),null}}async checkExistingMediaAccess(e){console.log("Checking if we already have media API access...");try{const t=await fetch(`https://media-api.squarespace.com/user/libraries/${e}/folders/root/assets?limit=1`,{method:"GET",headers:{accept:"application/json, text/plain, */*","x-library-id":e},credentials:"include",mode:"cors"});return t.ok?(console.log("‚úÖ Already have media API access - no auth needed!"),!0):401===t.status||403===t.status?(console.log("‚ùå Media API access denied - need to authorize"),!1):(console.log(`ü§î Unexpected response: ${t.status} - will try to authorize`),!1)}catch(e){return console.log("‚ùå Error checking media access - will try to authorize:",e),!1}}async getAssetLibraryAuth(e){console.log("Getting asset library authorization token...");try{const t=await fetch(`${window.location.origin}/api/media/auth/v1/library/authorization`,{method:"GET",headers:{accept:"application/json, text/plain, */*","accept-language":"en-GB,en-US;q=0.9,en;q=0.8","x-csrf-token":e},credentials:"include",mode:"cors"});if(t.ok){const e=await t.json();if(console.log("‚úÖ Asset library authorization successful"),e.token){if(await this.authorizeWithMediaAPI(e.token))return e}return console.log("‚ùå No token in auth data or media authorization failed"),null}return console.log("‚ùå Asset library authorization failed:",t.status,t.statusText),null}catch(e){return console.error("Error getting asset library authorization:",e),null}}async getAssetAuth(e){console.log("Getting asset authorization token for video playback...");try{const t=await fetch(`${window.location.origin}/api/media/auth/v1/asset/authorization`,{method:"GET",headers:{accept:"application/json, text/plain, */*","accept-language":"en-GB,en-US;q=0.9,en;q=0.8","x-csrf-token":e},credentials:"include",mode:"cors"});if(t.ok){const e=await t.json();return console.log("‚úÖ Asset authorization successful for video playback"),e}return console.log("‚ùå Asset authorization failed:",t.status,t.statusText),null}catch(e){return console.error("Error getting asset authorization:",e),null}}async getVideoThumbnail(e){try{let t=e?.assetUrl||"";if(!t)return console.log("‚ùå No video URL found in asset data"),null;const s=`${t.replace("/{variant}","").replace(/\/$/,"")}/thumbnail`;console.log("üì∏ Video URL:",t),console.log("üì∏ Thumbnail URL:",s);try{const e=await fetch(s,{method:"HEAD"});return e.ok?(console.log("‚úÖ Video thumbnail found:",s),s):(console.log("‚ùå Thumbnail not accessible:",e.status),null)}catch(e){return console.log("‚ùå Error testing thumbnail URL:",e),null}}catch(e){return console.error("Error getting video thumbnail:",e),null}}async authorizeWithMediaAPI(e){console.log("Authorizing with media API using JWT token...");try{const t=await fetch("https://media-api.squarespace.com/user/authorize",{method:"POST",headers:{accept:"application/json, text/plain, */*","accept-language":"en-GB,en-US;q=0.9,en;q=0.8","content-type":"text/plain"},body:e,credentials:"include",mode:"cors"});return t.ok?(console.log("‚úÖ Media API authorization successful"),!0):(console.log("‚ùå Media API authorization failed:",t.status,t.statusText),!1)}catch(e){return console.error("Error authorizing with media API:",e),!1}}async authorizePrivateVideo(e){console.log("üé¨ üîê Authorizing private video for public access...");try{const t=this.getCdnEdgeToken();if(!t)throw new Error("No CSRF token available");const s=e.assetUrl.split("/"),o=s[s.length-2];if(!o||"{variant}"===o)throw new Error("Could not extract systemDataId from asset URL");console.log(`üé¨ Creating video reference for systemDataId: ${o}`);const i=await this.getWebsiteId(t);if(!i)throw new Error("Could not retrieve website ID");console.log(`üé¨ Using website ID: ${i}`);const n=`${window.location.origin}/api/content-service/asset/1.0/websites/${i}/video-asset/video-reference`,a=await fetch(n,{method:"POST",headers:{accept:"application/json, text/plain, */*","content-type":"application/json","x-csrf-token":t},body:JSON.stringify({authorId:this.getCurrentAuthorId()||"52e83bdbe4b047367adeef5b",systemDataId:o}),credentials:"include",mode:"cors"});if(!a.ok){const e=await a.text();throw new Error(`Video reference API failed: ${a.status} - ${e}`)}const r=await a.json();if(console.log("üé¨ ‚úÖ Video reference created:",r),r.id){console.log("üé¨ üìã Getting content item details for ID:",r.id);const e=await fetch(`${window.location.origin}/api/content-items/${r.id}`,{method:"GET",headers:{accept:"application/json, text/plain, */*","x-csrf-token":t},credentials:"include",mode:"cors"});if(e.ok){const t=await e.json();if(console.log("üé¨ üìã Content item retrieved:",t),t.alexandriaUrl||t.structuredContent?.alexandriaUrl){const e=t.alexandriaUrl||t.structuredContent.alexandriaUrl;console.log("üé¨ üîì Got accessible video URL:",e),r.accessibleVideoUrl=e}}}console.log("üé¨ üîê Getting media authorization for video access...");const l=await fetch(`${window.location.origin}/api/media/auth/v1/asset/authorization`,{method:"GET",headers:{accept:"application/json, text/plain, */*","x-csrf-token":t},credentials:"include",mode:"cors"});if(l.ok){const e=await l.json();console.log("üé¨ ‚úÖ Media authorization obtained:",e),e&&e.token?(this.mediaAuthToken=e.token,console.log("üé¨ üìù Stored media auth token")):console.warn("üé¨ ‚ö†Ô∏è  No token found in auth result:",e)}else console.warn("üé¨ ‚ö†Ô∏è  Media authorization failed, but video reference was created");if(r&&r.id){console.log("üé¨ üíæ Saving content item reference to make video public...");try{await this.saveVideoContentItem(r.id,e),console.log("üé¨ ‚úÖ Video content item saved - video should now be public")}catch(e){console.warn("üé¨ ‚ö†Ô∏è  Failed to save content item reference:",e)}}return r}catch(e){throw console.error("üé¨ ‚ùå Error authorizing private video:",e),e}}async performFauxSectionSave(e,t,s=null){console.log("üé¨ Activating video via lesson service, systemDataId:",e);const o="68bb0470e2b53a5b914fe103",i="68f73fb1b3e6e851023d16d1",n="52e83bdbe4b047367adeef5b";try{console.log("üé¨ üîç Checking if video is already in collection...");const a=await this.findExistingVideoLesson(e,o,i,t);if(a)return console.log("üé¨ ‚úÖ Video already exists in collection:",a.id,"Title:",a.title),console.log("üé¨ üéØ Video is already activated and should be accessible"),!0;let r="";s&&(r=s.replace(/\.[^/.]+$/,"").replace(/[-_]/g," ").replace(/\b\w/g,e=>e.toUpperCase())),console.log("üé¨ üìù Creating new lesson for video...");const l={workflowState:"DRAFT",websiteId:o,authorId:n,category:null,parentCollectionId:i,addedOn:Date.now(),publishOn:Date.now(),title:r||`Video ${Date.now()}`},d=await fetch(`/api/lesson-service/1.0/websites/${o}/lessons/${i}/lesson`,{method:"POST",headers:{accept:"application/json","content-type":"application/json","x-csrf-token":t},body:JSON.stringify(l),credentials:"include",mode:"cors"});if(!d.ok)throw new Error(`Failed to create lesson: ${d.status}`);const c=await d.json();console.log("üé¨ ‚úÖ Lesson created:",c.id,"with title:",c.title),console.log("üé¨ üé• Attaching video to lesson...");const u={systemDataId:e,authorId:n},m=await fetch(`/api/lesson-service/1.0/websites/${o}/lessons/${i}/lesson/${c.id}/video/hosted`,{method:"POST",headers:{accept:"application/json, text/plain, */*","content-type":"application/json","x-csrf-token":t},body:JSON.stringify(u),credentials:"include",mode:"cors"});if(!m.ok)throw new Error(`Failed to attach video: ${m.status}`);await m.json();return console.log("üé¨ ‚úÖ Video attached to lesson successfully!"),console.log("üé¨ üéØ Video is now permanently activated and should be accessible"),!0}catch(e){return console.log("üé¨ ‚ùå Lesson service activation failed:",e),!1}}async findExistingVideoLesson(e,t,s,o){try{console.log("üé¨ üìã Searching lesson collection for existing video...");const i=await fetch(`/api/lesson-service/1.0/websites/${t}/lessons/${s}/lessons?limit=100`,{method:"GET",headers:{accept:"application/json","x-csrf-token":o},credentials:"include"});if(!i.ok)return console.log("üé¨ ‚ö†Ô∏è  Could not fetch lessons to check for duplicates"),null;const n=await i.json();if(console.log(`üé¨ üìã Found ${n.lessons?.length||0} lessons in collection`),n.lessons)for(const t of n.lessons)if(t.assets?.video?.id===e||t.lessonContent?.hostedVideo?.id===e)return console.log("üé¨ üéØ Found existing lesson with our video:",t.id),t;return console.log("üé¨ üìã Video not found in existing lessons"),null}catch(e){return console.log("üé¨ ‚ö†Ô∏è  Error checking for existing lessons:",e),null}}getCrumbToken(){const e=document.querySelector('meta[name="crumb"]');if(e)return e.getAttribute("content");const t=document.querySelector('input[name="crumb"]');if(t)return t.value;const s=document.cookie.split(";").find(e=>e.trim().startsWith("crumb="));return s?s.split("=")[1]:null}getWebsiteIdFromUrl(){window.location.pathname.split("/"),window.location.hostname;return null}getCurrentAuthorId(){try{return window.Static&&window.Static.SQUARESPACE_CONTEXT&&window.Static.SQUARESPACE_CONTEXT.authenticatedAccount?window.Static.SQUARESPACE_CONTEXT.authenticatedAccount.id:null}catch(e){return null}}async listAssetLibraryMedia(e,t,s={}){console.log("Fetching media assets from Asset Library...");const{limit:o=100,offset:i=0,orderBy:n="CREATED_AT",order:a="DESC",assetTypes:r="IMAGE,VIDEO"}=s,l=`https://media-api.squarespace.com/user/libraries/${e}/folders/root/assets?${new URLSearchParams({order:a,orderBy:n,assetTypes:r,limit:o,offset:i}).toString()}`;try{const t=await fetch(l,{method:"GET",headers:{accept:"application/json, text/plain, */*","accept-language":"en-GB,en-US;q=0.9,en;q=0.8","x-library-id":e},credentials:"include",mode:"cors",referrerPolicy:"strict-origin-when-cross-origin"});if(!t.ok)throw new Error(`Failed to list assets: ${t.status} ${t.statusText}`);const s=await t.json();if(s.assets&&s.assets.assetRecords){console.log(`Successfully listed ${s.assets.assetRecords.length} assets. Total assets in library: ${s.assets.total}`);const e=s.assets.assetRecords.reduce((e,t)=>(e[t.assetType]=(e[t.assetType]||0)+1,e),{});console.log("Asset types found:",e);const t=s.assets.assetRecords.filter(e=>"VIDEO"===e.assetType);return console.log(`Found ${t.length} video assets:`,t.map(e=>({id:e.id,filename:e.filename,thumbnails:e.thumbnails}))),s.assets.assetRecords}return console.warn("Asset listing response did not contain expected 'assetRecords'."),[]}catch(e){return console.error("Error listing assets:",e),[]}}preventSquarespaceInterference(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()}getVideoPlaylistUrl(e){if(console.log("üé¨ getVideoPlaylistUrl input:",e),e.includes("{variant}")){const t=e.replace("/{variant}","")+"/playlist.m3u8";return console.log("üé¨ Converted URL:",t),t}return e.includes("alexandriaUrl")?e.replace("{variant}","")+"playlist.m3u8":e.includes("squarespace-cdn.com")&&!e.includes(".m3u8")?e.replace(/\.[^.]+$/,"")+"/playlist.m3u8":(console.log("üé¨ No conversion needed, returning original URL:",e),e)}setupHLSVideo(e,t,s=!0,o=null){console.log("üé¨ ================================="),console.log("üé¨ Setting up HLS for video:",t),console.log("üé¨ Video element:",e),console.log("üé¨ Current auth token available:",!!this.mediaAuthToken),console.log("üé¨ Autoplay enabled:",s),console.log("üé¨ Video metadata available:",!!o),e._hlsInstance&&(console.log("üé¨ üßπ Destroying existing HLS instance to prevent caching"),e._hlsInstance.destroy(),e._hlsInstance=null),e.src&&e.src.startsWith("blob:")&&(console.log("üé¨ üßπ Clearing existing blob URL:",e.src),e.src="",e.load());let i=this.getVideoPlaylistUrl(t);if(console.log("üé¨ Original URL:",t),console.log("üé¨ Playlist URL (before cache-bust):",i),o&&o.assetData&&o.assetData.lastModified){const e=new Date(o.assetData.lastModified).getTime(),t=i.includes("?")?"&":"?";i=`${i}${t}v=${e}`,console.log("üé¨ ‚úÖ Added cache-busting with lastModified:",e),console.log("üé¨ Playlist URL (with cache-bust):",i)}else console.log("üé¨ ‚ö†Ô∏è  No metadata available for cache-busting");const n=!!this.mediaAuthToken,a=n&&t.includes("{variant}");console.log("üé¨ Has auth token:",n),console.log("üé¨ Video URL contains {variant}:",t.includes("{variant}")),console.log("üé¨ Video needs authentication:",a),this.createNativeStyleHLSPlayer(e,i,a,s),console.log("üé¨ =================================")}createNativeStyleHLSPlayer(e,t,s=!1,o=!0){if(console.log("üé¨ Creating native-style HLS player for:",t),console.log("üé¨ Authentication needed:",s),console.log("üé¨ Autoplay enabled:",o),Hls.isSupported()){const i=new Hls({enableWorker:!0,lowLatencyMode:!0,xhrSetup:(e,t)=>{e.setRequestHeader("accept","application/json, text/plain, */*"),s&&this.mediaAuthToken?(e.setRequestHeader("authorization",`Bearer ${this.mediaAuthToken}`),console.log("üé¨ Added authorization header (no credentials) for:",t)):console.log("üé¨ Using default configuration for public video:",t),console.log("üé¨ Native-style request configured for:",t)}});e._hlsInstance=i,i.loadSource(t),i.attachMedia(e),i.on(Hls.Events.MANIFEST_PARSED,()=>{console.log("üé¨ ‚úÖ Native-style HLS manifest loaded successfully"),console.log("üé¨ Video src:",e.src),console.log("üé¨ Video readyState:",e.readyState),console.log("üé¨ HLS levels:",i.levels),o?e.play().catch(e=>{console.log("üé¨ Autoplay prevented by browser:",e)}):console.log("üé¨ Autoplay disabled for this video")}),i.on(Hls.Events.ERROR,(t,s)=>{console.log("üé¨ ‚ùå Native-style HLS error:",s);const o=s.response&&401===s.response.code;if(!s.fatal||e.src&&e.src.startsWith("blob:"))s.fatal&&e.src&&e.src.startsWith("blob:")?console.log("üé¨ ‚úÖ Fatal error but video has blob URL, should still work"):console.log("üé¨ ‚ÑπÔ∏è  Non-fatal error, video should continue");else{console.log("üé¨ ‚ùå Fatal error without blob URL, showing error message");const t=o?"Private video - add to a video block first":"Video unavailable";this.showVideoError(e,t)}})}else e.canPlayType("application/vnd.apple.mpegurl")?(console.log("üé¨ Using Safari native HLS"),e.src=t):(console.log("üé¨ HLS not supported, using original URL"),e.src=videoUrl)}showVideoError(e,t){e.style.display="none";const s=document.createElement("div");s.style.cssText="\n                display: flex;\n                align-items: center; \n                justify-content: center;\n                width: 100%;\n                height: 100%;\n                background: #f5f5f5;\n                color: #666;\n                font-size: 14px;\n                text-align: center;\n                border-radius: 4px;\n            ",s.innerHTML=`üé¨<br>${t}<br><small>Available in admin mode</small>`;const o=e.parentElement;o&&o.appendChild(s)}showRowOptionsMenu(e,t){const s=document.querySelector(".row-options-menu");s&&s.remove();const o=document.createElement("div");o.className="row-options-menu";const i=e.target.getBoundingClientRect();o.style.top=`${i.bottom+5}px`,o.style.right=window.innerWidth-i.right+"px";const n=this.gridData[t];n&&(o.innerHTML=`\n                <button class="menu-option-draft" data-row-index="${t}">${n.isDraft?"Publish Row":"Make Draft"}</button>\n                <button class="menu-option-duplicate" data-row-index="${t}">Duplicate Row</button>\n                <button class="menu-option-delete delete-option" data-row-index="${t}">Delete Row</button>\n            `,document.body.appendChild(o),setTimeout(()=>{const e=t=>{o.contains(t.target)||(o.remove(),document.removeEventListener("mousedown",e))};document.addEventListener("mousedown",e)},10))}toggleRowDraft(e){if(!this.gridData[e])return;const t=this.gridData[e];t.isDraft=!t.isDraft;const s=document.querySelector(".row-options-menu");s&&s.remove(),this.renderAdminForm(),this.renderGrid(),this.markAsChanged()}duplicateRow(e){if(!this.gridData[e])return;const t=this.gridData[e],s=JSON.parse(JSON.stringify(t));this.gridData.splice(e+1,0,s);const o=document.querySelector(".row-options-menu");o&&o.remove(),this.renderAdminForm(),this.renderGrid(),this.markAsChanged()}deleteRow(e){if(confirm("Are you sure you want to delete this row?")){if(!this.gridData[e])return;this.gridData.splice(e,1);const t=document.querySelector(".row-options-menu");t&&t.remove(),this.renderAdminForm(),this.renderGrid(),this.markAsChanged()}}moveRowUp(e){if(e<=0||!this.gridData[e])return;const t=this.gridData[e];this.gridData[e]=this.gridData[e-1],this.gridData[e-1]=t,this.renderAdminForm(),this.renderGrid(),this.markAsChanged(),setTimeout(()=>{const t=document.querySelector(".admin-controls");if(!(t&&t.classList.contains("reorder-mode"))){const t=document.querySelector(`[data-row-index="${e-1}"]`);t&&!t.classList.contains("expanded")&&this.toggleAccordion(t)}},100)}moveRowDown(e){if(e>=this.gridData.length-1||!this.gridData[e])return;const t=this.gridData[e];this.gridData[e]=this.gridData[e+1],this.gridData[e+1]=t,this.renderAdminForm(),this.renderGrid(),this.markAsChanged(),setTimeout(()=>{const t=document.querySelector(".admin-controls");if(!(t&&t.classList.contains("reorder-mode"))){const t=document.querySelector(`[data-row-index="${e+1}"]`);t&&!t.classList.contains("expanded")&&this.toggleAccordion(t)}},100)}toggleReorderMode(){const e=document.querySelector(".reorder-toggle-btn"),t=!("true"===e.getAttribute("data-reorder-active"));e.setAttribute("data-reorder-active",t.toString()),t?(e.textContent="Confirm Order",e.title="Click to confirm the new row order"):(e.textContent="Change Order",e.title="Toggle row reordering mode");const s=document.querySelector(".admin-controls");s&&(t?s.classList.add("reorder-mode"):s.classList.remove("reorder-mode")),console.log("üîÑ Reorder mode "+(t?"enabled":"disabled"))}resetReorderMode(){const e=document.querySelector(".reorder-toggle-btn"),t=document.querySelector(".admin-controls");e&&(e.setAttribute("data-reorder-active","false"),e.textContent="Change Order",e.title="Toggle row reordering mode"),t&&t.classList.remove("reorder-mode"),console.log("üîÑ Reorder mode reset to default state")}openLightbox(e,t){if(this.isAdminMode)return;const s=[];let o=0;this.gridData.forEach((i,n)=>{i.isDraft||i.items.forEach((i,a)=>{"placeholder"===i.type||"image"!==i.type&&"video"!==i.type||!i.content||(n===e&&a===t&&(o=s.length),s.push({...i,rowIndex:n,itemIndex:a}))})}),0!==s.length&&(this.lightboxItems=s,this.currentLightboxIndex=o,this.createLightboxElement(),this.showLightboxItem(this.currentLightboxIndex))}createLightboxElement(){const e=document.querySelector(".gallery-lightbox");e&&e.remove(),this.lightbox=document.createElement("div"),this.lightbox.className="gallery-lightbox",this.lightbox.innerHTML='\n                <div class="lightbox-content">\n                    <div class="lightbox-media-container"></div>\n                </div>\n                <button class="lightbox-nav prev">\n                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                    </svg>\n                </button>\n                <button class="lightbox-nav next">\n                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                    </svg>\n                </button>\n                <button class="lightbox-close">\n                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                    </svg>\n                </button>\n            ',document.body.appendChild(this.lightbox),this.lightbox.querySelector(".lightbox-close").addEventListener("click",()=>this.closeLightbox()),this.lightbox.querySelector(".lightbox-nav.prev").addEventListener("click",()=>this.previousLightboxItem()),this.lightbox.querySelector(".lightbox-nav.next").addEventListener("click",()=>this.nextLightboxItem()),this.lightbox.addEventListener("click",e=>{e.target===this.lightbox&&this.closeLightbox()}),this.lightboxKeyHandler=e=>{"Escape"===e.key&&this.closeLightbox(),"ArrowLeft"===e.key&&this.previousLightboxItem(),"ArrowRight"===e.key&&this.nextLightboxItem()},document.addEventListener("keydown",this.lightboxKeyHandler),setTimeout(()=>{this.lightbox.classList.add("show"),this.scrollPosition=window.pageYOffset||document.documentElement.scrollTop,document.body.style.top=`-${this.scrollPosition}px`,document.body.style.position="fixed",document.body.style.width="100%",document.body.classList.add("lightbox-open"),this.pauseAllGalleryVideos()},10)}showLightboxItem(e){if(!this.lightboxItems||e<0||e>=this.lightboxItems.length)return;const t=this.lightboxItems[e],s=this.lightbox.querySelector(".lightbox-media-container"),o=this.lightbox.querySelector(".lightbox-nav.prev"),i=this.lightbox.querySelector(".lightbox-nav.next");o.disabled=0===e,i.disabled=e===this.lightboxItems.length-1,s.classList.add("transitioning"),setTimeout(()=>{if(s.innerHTML="","image"===t.type){const o=document.createElement("img");o.className="lightbox-media",o.src=t.content,o.alt=t.title||`Gallery image ${e+1}`,o.style.cursor="pointer",o.addEventListener("click",e=>{const t=o.getBoundingClientRect();e.clientX-t.left<t.width/2?this.previousLightboxItem():this.nextLightboxItem()}),s.appendChild(o)}else if("video"===t.type){const e=document.createElement("video");if(e.className="lightbox-media",e.controls=!0,e.autoplay=!1,e.loop=!1,e.preload="metadata",e.setAttribute("playsinline",""),e.setAttribute("webkit-playsinline",""),t.content.includes("squarespace-cdn.com")&&t.content.includes("{variant}"))if("undefined"==typeof Hls){const s=document.createElement("script");s.src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js",s.onload=()=>{this.setupHLSVideo(e,t.content,!1,t.metadata)},document.head.appendChild(s)}else this.setupHLSVideo(e,t.content,!1,t.metadata);else e.src=t.content;e.addEventListener("click",t=>{if((e.currentTime||0)<2)return;const s=e.getBoundingClientRect();t.clientX-s.left<s.width/2?this.previousLightboxItem():this.nextLightboxItem()}),s.appendChild(e);const o=document.createElement("div");o.className="lightbox-play-button",o.addEventListener("click",t=>{t.stopPropagation(),e.paused&&(e.play(),o.classList.add("hidden"))}),e.addEventListener("play",()=>{o.classList.add("hidden")}),e.addEventListener("pause",()=>{o.classList.remove("hidden")}),e.addEventListener("ended",()=>{o.classList.remove("hidden")}),s.appendChild(o)}setTimeout(()=>{s.classList.remove("transitioning")},50)},150)}previousLightboxItem(){this.currentLightboxIndex>0&&(this.currentLightboxIndex--,this.showLightboxItem(this.currentLightboxIndex))}nextLightboxItem(){this.currentLightboxIndex<this.lightboxItems.length-1&&(this.currentLightboxIndex++,this.showLightboxItem(this.currentLightboxIndex))}closeLightbox(){this.lightbox&&(this.lightbox.classList.remove("show"),document.body.classList.remove("lightbox-open"),document.body.style.position="",document.body.style.top="",document.body.style.width="","number"==typeof this.scrollPosition&&(window.scrollTo(0,this.scrollPosition),this.scrollPosition=null),this.resumeGalleryVideos(),this.lightboxKeyHandler&&(document.removeEventListener("keydown",this.lightboxKeyHandler),this.lightboxKeyHandler=null),setTimeout(()=>{this.lightbox&&(this.lightbox.remove(),this.lightbox=null),this.lightboxItems=null,this.currentLightboxIndex=0},400))}addScrollDebugging(){console.log("üîß Adding scroll debugging...");const e=document.querySelector(".admin-left-column"),t=document.querySelector(".admin-right-column"),s=document.querySelector(".admin-main-container"),o=document.querySelector(".tab-panels-container");o&&console.log("üì¶ Tab panels container height:",o.clientHeight,"scrollHeight:",o.scrollHeight),s&&console.log("üì¶ Main container height:",s.clientHeight,"scrollHeight:",s.scrollHeight),e&&(console.log("üìã Setting up left column scroll debugging"),console.log("üìã Left column height:",e.clientHeight,"scrollHeight:",e.scrollHeight),console.log("üìã Left column computed height:",window.getComputedStyle(e).height),console.log("üìã Left column max-height:",window.getComputedStyle(e).maxHeight),e.addEventListener("scroll",()=>{console.log("üìã Left column scrolled! ScrollTop:",e.scrollTop)}),e.addEventListener("wheel",t=>{console.log("üìã Left column wheel event:",t.deltaY,"Can scroll:",e.scrollHeight>e.clientHeight)})),t&&(console.log("üìä Setting up right column scroll debugging"),console.log("üìä Right column height:",t.clientHeight,"scrollHeight:",t.scrollHeight),console.log("üìä Right column computed height:",window.getComputedStyle(t).height),console.log("üìä Right column max-height:",window.getComputedStyle(t).maxHeight),t.addEventListener("scroll",()=>{console.log("üìä Right column scrolled! ScrollTop:",t.scrollTop)}),t.addEventListener("wheel",e=>{console.log("üìä Right column wheel event:",e.deltaY,"Can scroll:",t.scrollHeight>t.clientHeight)}))}pauseAllGalleryVideos(){const e=this.container.querySelectorAll("video");this.pausedVideos=[],e.forEach(e=>{e.paused||(this.pausedVideos.push(e),e.pause())}),console.log("üé¨ Paused",this.pausedVideos.length,"gallery videos for lightbox")}resumeGalleryVideos(){this.pausedVideos&&this.pausedVideos.length>0&&(this.pausedVideos.forEach(e=>{e.parentNode&&e.play().catch(e=>{console.log("üé¨ Could not resume video:",e)})}),console.log("üé¨ Resumed",this.pausedVideos.length,"gallery videos after lightbox close"),this.pausedVideos=[])}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.masonryWidget=new e}):window.masonryWidget=new e}();